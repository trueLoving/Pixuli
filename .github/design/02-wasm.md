# âš¡ WASM æ¨¡å—è®¾è®¡æ–¹æ¡ˆ

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† Pixuli é¡¹ç›®ä¸­ WASMï¼ˆWebAssemblyï¼‰æ¨¡å—çš„è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è®¾è®¡ç›®çš„ã€è´Ÿè´£å†…å®¹ã€æ¶æ„è®¾è®¡ã€åº”ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹ã€‚

---

## ğŸ¯ è®¾è®¡ç›®çš„

### æ ¸å¿ƒç›®æ ‡

- **é«˜æ€§èƒ½**ï¼šä½¿ç”¨ Rust å®ç°å›¾ç‰‡å¤„ç†åŠŸèƒ½ï¼Œæä¾›æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½
- **è·¨å¹³å°è¿è¡Œ**ï¼šæ”¯æŒä¸åŒè¿è¡Œç¯å¢ƒçš„éƒ¨ç½²
  - **Node ç«¯ï¼ˆæ¨èï¼‰**ï¼šé€šè¿‡ NAPI-RS ç¼–è¯‘ä¸ºåŸç”Ÿæ¨¡å—ï¼Œåœ¨ Node.js å’Œ Electron ç¯å¢ƒä¸­è¿è¡Œ
  - **Web ç«¯ï¼ˆå¯é€‰ï¼‰**ï¼šç¼–è¯‘ä¸º WASM æ ¼å¼ï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰
  - **ç§»åŠ¨ç«¯ï¼ˆå¯é€‰ï¼‰**ï¼šç¼–è¯‘ä¸º WASM æ ¼å¼ï¼Œåœ¨ React
    Native ç¯å¢ƒä¸­è¿è¡Œï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰
- **å†…å­˜å®‰å…¨**ï¼šåˆ©ç”¨ Rust çš„å†…å­˜å®‰å…¨ç‰¹æ€§ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œç¼“å†²åŒºæº¢å‡º
- **ç±»å‹å®‰å…¨**ï¼šé€šè¿‡ TypeScript ç±»å‹å®šä¹‰ç¡®ä¿æ¥å£ç±»å‹å®‰å…¨
- **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- **ç®€åŒ–æ„å»º**ï¼šä¼˜å…ˆä½¿ç”¨ NAPI ç»Ÿä¸€ç¼–è¯‘æµç¨‹ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬

### è§£å†³çš„é—®é¢˜

- **æ€§èƒ½ç“¶é¢ˆ**ï¼šJavaScript å¤„ç†å¤§é‡å›¾ç‰‡æ—¶æ€§èƒ½ä¸è¶³
- **å†…å­˜ç®¡ç†**ï¼šéœ€è¦ç²¾ç¡®æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼
- **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒæ‰¹é‡å›¾ç‰‡å¤„ç†ï¼Œæé«˜å¤„ç†æ•ˆç‡
- **æ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼çš„è½¬æ¢å’Œå¤„ç†
- **è·¨ç¯å¢ƒè¿è¡Œ**ï¼šåŒä¸€å¥—ä»£ç åœ¨ä¸åŒç¯å¢ƒä¸­è¿è¡Œ
- **æ„å»ºå¤æ‚åº¦**ï¼šç®€åŒ–å¤šå¹³å°ç¼–è¯‘æµç¨‹ï¼Œç»Ÿä¸€ä½¿ç”¨ NAPI

### æŠ€æœ¯é€‰å‹è¯´æ˜

**å½“å‰å®ç°ï¼šåŸºäº NAPI-RS**

é¡¹ç›®**å½“å‰ä½¿ç”¨ NAPI-RS å®ç°**ï¼Œç¼–è¯‘ä¸º Node.js åŸç”Ÿæ¨¡å—ï¼ˆ`.node` æ–‡ä»¶ï¼‰ã€‚

- **å½“å‰çŠ¶æ€**ï¼š
  - âœ… å·²å®ç°å¹¶è¿è¡Œåœ¨ Node.js/Electron ç¯å¢ƒ
  - âœ… æ€§èƒ½æœ€ä¼˜ï¼ˆåŸç”Ÿæ¨¡å—ï¼‰
  - âœ… æ”¯æŒå¤šå¹³å°ç¼–è¯‘ï¼ˆWindowsã€macOSã€Linuxï¼‰
  - âŒ ä¸æ”¯æŒçº¯æµè§ˆå™¨ç¯å¢ƒ
  - âŒ ä¸æ”¯æŒ React Native ç§»åŠ¨ç«¯

- **é€‚ç”¨åœºæ™¯**ï¼š
  - PC ç«¯åº”ç”¨ï¼ˆElectronï¼‰
  - Node.js åç«¯æœåŠ¡
  - ä¸éœ€è¦æµè§ˆå™¨å’Œç§»åŠ¨ç«¯æ”¯æŒçš„æƒ…å†µ

**æ¨èæ–¹æ¡ˆï¼šç»Ÿä¸€ä½¿ç”¨ WASMï¼ˆæ”¯æŒæ‰€æœ‰å¹³å°ï¼‰**

å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒ React
Nativeã€Web å’Œ Electronï¼Œ**æ¨èè¿ç§»åˆ° WASM ç»Ÿä¸€æ„å»ºæ–¹æ¡ˆ**ï¼Œåªéœ€ç»´æŠ¤ä¸€å¥—ä»£ç å’Œæ„å»ºé…ç½®ã€‚

- **ä¼˜åŠ¿**ï¼š
  - âœ… **ä¸€å¥—ä»£ç ï¼Œæ‰€æœ‰å¹³å°é€šç”¨**ï¼šNode.jsã€Electronã€æµè§ˆå™¨ã€React Native
  - âœ… **ç»Ÿä¸€æ„å»ºæµç¨‹**ï¼šåªéœ€ `wasm-pack build` å‘½ä»¤ï¼Œæ„å»ºç®€å•
  - âœ… **è·¨å¹³å°å…¼å®¹æ€§å¥½**ï¼šWASM æ˜¯ Web æ ‡å‡†ï¼Œæ‰€æœ‰ç°ä»£ç¯å¢ƒéƒ½æ”¯æŒ
  - âœ… **Node.js åŸç”Ÿæ”¯æŒ**ï¼šNode.js v8.0.0+ åŸç”Ÿæ”¯æŒ WASM
  - âœ… **Electron å®Œç¾æ”¯æŒ**ï¼šElectron åŸºäº Node.jsï¼Œå®Œå…¨æ”¯æŒ WASM
  - âœ… **React Native æ”¯æŒ**ï¼šé€šè¿‡ WASM è¿è¡Œæ—¶ï¼ˆå¦‚ wasmtimeã€wasmerï¼‰æ”¯æŒ
  - âœ… **ç»´æŠ¤æˆæœ¬ä½**ï¼šåªéœ€ç»´æŠ¤ä¸€å¥—ä»£ç å’Œæ„å»ºé…ç½®

- **æ€§èƒ½è¯´æ˜**ï¼š
  - æ€§èƒ½çº¦ä¸º NAPI åŸç”Ÿæ¨¡å—çš„ 80-90%ï¼ˆå¯¹äºå¤§å¤šæ•°åœºæ™¯è¶³å¤Ÿï¼‰
  - å¯åŠ¨æ—¶é—´ç¨é•¿ï¼ˆé¦–æ¬¡åŠ è½½éœ€è¦åˆå§‹åŒ– WASM æ¨¡å—ï¼‰
  - å¯ä»¥é€šè¿‡é¢„åŠ è½½å’Œç¼“å­˜ä¼˜åŒ–å¯åŠ¨æ—¶é—´

- **é™åˆ¶**ï¼š
  - æŸäº›ä¾èµ–ï¼ˆå¦‚ ONNX Runtimeï¼‰å¯èƒ½ä¸æ”¯æŒ WASMï¼ˆéœ€è¦æ¡ä»¶ç¼–è¯‘ï¼‰
  - æ€§èƒ½ç•¥ä½äº NAPIï¼ˆä½†å¯¹äºå›¾ç‰‡å¤„ç†åœºæ™¯ï¼Œå·®å¼‚å¯æ¥å—ï¼‰

- **é€‚ç”¨åœºæ™¯**ï¼š
  - âœ… **éœ€è¦æ”¯æŒæ‰€æœ‰å¹³å°**ï¼ˆReact Nativeã€Webã€Electronï¼‰
  - âœ… **å¸Œæœ›ç»Ÿä¸€æ„å»ºæµç¨‹**
  - âœ… **æ€§èƒ½è¦æ±‚ä¸æ˜¯æè‡´**ï¼ˆ80-90% çš„æ€§èƒ½å·²ç»è¶³å¤Ÿå¥½ï¼‰

**å¯é€‰æ–¹æ¡ˆï¼šNAPI + WASM æ··åˆï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰**

å¦‚æœéœ€è¦æè‡´æ€§èƒ½ï¼Œå¯ä»¥ä¿æŒå½“å‰ NAPI-RS å®ç°ï¼ŒåŒæ—¶æä¾› WASM ç‰ˆæœ¬ï¼š

- **ä¼˜åŠ¿**ï¼š
  - Electron/Node.js ä½¿ç”¨ NAPIï¼ˆæ€§èƒ½æœ€ä¼˜ï¼Œ100% æ€§èƒ½ï¼‰
  - Web/React Native ä½¿ç”¨ WASMï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
  - é€šè¿‡ package.json çš„ exports å­—æ®µè‡ªåŠ¨é€‰æ‹©
  - ä¿æŒç°æœ‰ NAPI å®ç°ä¸å˜

- **å®ç°æ–¹å¼**ï¼š
  - ä¿æŒç°æœ‰ NAPI-RS ä»£ç å’Œæ„å»ºæµç¨‹
  - æ·»åŠ  WASM æ„å»ºé…ç½®ï¼ˆä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼‰
  - é€šè¿‡ package.json çš„ exports å­—æ®µå®ç°æ™ºèƒ½åŠ è½½

- **é™åˆ¶**ï¼š
  - éœ€è¦ç»´æŠ¤ä¸¤å¥—æ„å»ºé…ç½®
  - æ„å»ºå¤æ‚åº¦å¢åŠ 
  - ä»£ç éœ€è¦æ¡ä»¶ç¼–è¯‘ï¼ˆåŒºåˆ† NAPI å’Œ WASMï¼‰

- **é€‚ç”¨åœºæ™¯**ï¼š
  - å¯¹ Electron æ€§èƒ½è¦æ±‚æé«˜
  - éœ€è¦æ”¯æŒ Web/React Native
  - æ„¿æ„æ‰¿æ‹…é¢å¤–çš„ç»´æŠ¤æˆæœ¬

**è¿ç§»å»ºè®®**

å¦‚æœå½“å‰åªéœ€è¦æ”¯æŒ Electronï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ NAPI-RSã€‚å¦‚æœéœ€è¦æ”¯æŒ Web å’Œ React
Nativeï¼Œå»ºè®®ï¼š

1. **çŸ­æœŸæ–¹æ¡ˆ**ï¼šä¿æŒ NAPI-RSï¼Œæ·»åŠ  WASM æ„å»ºï¼ˆæ··åˆæ–¹æ¡ˆï¼‰
2. **é•¿æœŸæ–¹æ¡ˆ**ï¼šé€æ­¥è¿ç§»åˆ°ç»Ÿä¸€ WASM æ–¹æ¡ˆï¼ˆç®€åŒ–ç»´æŠ¤ï¼‰

---

## ğŸ“¦ è´Ÿè´£å†…å®¹

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1. å›¾ç‰‡å‹ç¼©æ¨¡å— (compress)

- **WebP å‹ç¼©**ï¼šæ”¯æŒæœ‰æŸå’Œæ— æŸ WebP æ ¼å¼å‹ç¼©
- **è´¨é‡æ§åˆ¶**ï¼šå¯è°ƒèŠ‚å‹ç¼©è´¨é‡ï¼ˆ0-100ï¼‰
- **æ‰¹é‡å‹ç¼©**ï¼šæ”¯æŒå¤šå¼ å›¾ç‰‡æ‰¹é‡å‹ç¼©å¤„ç†
- **å‹ç¼©ç»Ÿè®¡**ï¼šè¿”å›è¯¦ç»†çš„å‹ç¼©ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‹ç¼©ç‡ã€å¤§å°ç­‰ï¼‰

#### 2. å›¾ç‰‡æ ¼å¼è½¬æ¢æ¨¡å— (convert)

- **å¤šæ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒ JPEGã€PNGã€WebPã€GIFã€BMPã€TIFF æ ¼å¼è½¬æ¢
- **æ™ºèƒ½è½¬æ¢**ï¼šè‡ªåŠ¨å¤„ç†é€æ˜åº¦å’Œé¢œè‰²ç©ºé—´
- **å°ºå¯¸è°ƒæ•´**ï¼šæ”¯æŒå›¾ç‰‡å°ºå¯¸è°ƒæ•´å’Œå®½é«˜æ¯”ä¿æŒ
- **æ‰¹é‡è½¬æ¢**ï¼šæ”¯æŒå¤šå¼ å›¾ç‰‡æ‰¹é‡æ ¼å¼è½¬æ¢
- **è½¬æ¢é€‰é¡¹**ï¼šæ”¯æŒè´¨é‡ã€é€æ˜åº¦ã€æ— æŸç­‰é€‰é¡¹é…ç½®

#### 3. å›¾ç‰‡åˆ†ææ¨¡å— (analyze)

- **åŸºç¡€ä¿¡æ¯è·å–**ï¼š
  - è·å–å›¾ç‰‡å°ºå¯¸ã€æ ¼å¼ã€é€šé“æ•°ç­‰ä¿¡æ¯
  - æ£€æµ‹å›¾ç‰‡æ–‡ä»¶æ ¼å¼
  - åˆ†æå›¾ç‰‡ä¸»è¦é¢œè‰²
- **AI åˆ†æåŠŸèƒ½**ï¼š
  - å¯¹è±¡æ£€æµ‹ï¼šæ£€æµ‹å›¾ç‰‡ä¸­çš„å¯¹è±¡å’Œä½ç½®
  - åœºæ™¯è¯†åˆ«ï¼šè¯†åˆ«å›¾ç‰‡åœºæ™¯ç±»å‹
  - æ ‡ç­¾ç”Ÿæˆï¼šè‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡æ ‡ç­¾
  - æè¿°ç”Ÿæˆï¼šç”Ÿæˆå›¾ç‰‡æè¿°æ–‡æœ¬
- **æ¨¡å‹æ”¯æŒ**ï¼šæ”¯æŒ ONNX Runtime æ¨¡å‹ï¼ˆQwen ç­‰ï¼ŒNode ç«¯ï¼‰

#### 4. å›¾ç‰‡ç¼–è¾‘æ¨¡å— (edit)

- **è£å‰ªåŠŸèƒ½**ï¼š
  - çŸ©å½¢è£å‰ªï¼šæ”¯æŒæŒ‡å®šåŒºåŸŸè£å‰ª
  - å®½é«˜æ¯”è£å‰ªï¼šæ”¯æŒå›ºå®šå®½é«˜æ¯”è£å‰ª
  - æ™ºèƒ½è£å‰ªï¼šåŸºäºå†…å®¹è¯†åˆ«çš„æ™ºèƒ½è£å‰ª
- **æ—‹è½¬åŠŸèƒ½**ï¼š
  - è§’åº¦æ—‹è½¬ï¼šæ”¯æŒä»»æ„è§’åº¦æ—‹è½¬
  - 90åº¦æ—‹è½¬ï¼šå¿«é€Ÿæ—‹è½¬ï¼ˆ90Â°ã€180Â°ã€270Â°ï¼‰
  - è‡ªåŠ¨æ—‹è½¬ï¼šæ ¹æ® EXIF ä¿¡æ¯è‡ªåŠ¨æ—‹è½¬
- **ç¿»è½¬åŠŸèƒ½**ï¼š
  - æ°´å¹³ç¿»è½¬
  - å‚ç›´ç¿»è½¬
- **æ»¤é•œåŠŸèƒ½**ï¼š
  - äº®åº¦è°ƒæ•´
  - å¯¹æ¯”åº¦è°ƒæ•´
  - é¥±å’Œåº¦è°ƒæ•´
  - è‰²è°ƒè°ƒæ•´
  - æ¨¡ç³Šæ•ˆæœ
  - é”åŒ–æ•ˆæœ
  - ç°åº¦è½¬æ¢
  - å¤å¤æ»¤é•œ
  - é»‘ç™½æ»¤é•œ
- **æ‰¹é‡ç¼–è¾‘**ï¼šæ”¯æŒå¤šå¼ å›¾ç‰‡æ‰¹é‡åº”ç”¨ç¼–è¾‘æ“ä½œ

### æŠ€æœ¯ç‰¹æ€§

- **å¼‚æ­¥æ”¯æŒ**ï¼šæ‰€æœ‰å‡½æ•°éƒ½æ”¯æŒå¼‚æ­¥è°ƒç”¨
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé”™è¯¯ä¿¡æ¯è¿”å›
- **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **æµ‹è¯•è¦†ç›–**ï¼šå®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

#### å½“å‰æ¶æ„ï¼ˆåŸºäº NAPI-RSï¼‰

**å½“å‰å®ç°**ä½¿ç”¨ NAPI-RSï¼Œç¼–è¯‘ä¸º Node.js åŸç”Ÿæ¨¡å—ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust æºä»£ç  (packages/wasm/src)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ lib.rs (ä¸»å…¥å£)                                      â”‚ â”‚
â”‚ â”‚ - ä½¿ç”¨ #[napi] å®                                   â”‚ â”‚
â”‚ â”‚ - å½“å‰å®ç°                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â†“                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ compress/ (å‹ç¼©æ¨¡å—)                                 â”‚ â”‚
â”‚ â”‚ convert/ (è½¬æ¢æ¨¡å—)                                  â”‚ â”‚
â”‚ â”‚ analyze/ (åˆ†ææ¨¡å—)                                  â”‚ â”‚
â”‚ â”‚ edit/ (ç¼–è¾‘æ¨¡å—)                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ NAPI-RS ç¼–è¯‘              â”‚
        â”‚ - ä½¿ç”¨ #[napi] å®         â”‚
        â”‚ - è‡ªåŠ¨ç”Ÿæˆ Node.js ç»‘å®š   â”‚
        â”‚ - è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åŸç”Ÿæ¨¡å— (.node)           â”‚
        â”‚ - Windows: .node          â”‚
        â”‚ - macOS: .node            â”‚
        â”‚ - Linux: .node            â”‚
        â”‚ - æ”¯æŒå¤šæ¶æ„ (x64, arm64) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¿è¡Œç¯å¢ƒ                   â”‚
        â”‚ - Node.js                 â”‚
        â”‚ - Electron (PC ç«¯)        â”‚
        â”‚ - é€šè¿‡ require() åŠ è½½     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¨èæ¶æ„ï¼ˆç»Ÿä¸€ä½¿ç”¨ WASM - è¿ç§»æ–¹æ¡ˆï¼‰

å¦‚æœéœ€è¦æ”¯æŒæ‰€æœ‰å¹³å°ï¼Œæ¨èè¿ç§»åˆ°ç»Ÿä¸€çš„ WASM ç¼–è¯‘æ–¹æ¡ˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust æºä»£ç  (packages/wasm/src)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ lib.rs (ä¸»å…¥å£)                                      â”‚ â”‚
â”‚ â”‚ - æ¨¡å—å¯¼å‡º                                           â”‚ â”‚
â”‚ â”‚ - å…¬å…±æ¥å£                                           â”‚ â”‚
â”‚ â”‚ - ä½¿ç”¨ #[wasm_bindgen] å®                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â†“                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ compress/ (å‹ç¼©æ¨¡å—)                                 â”‚ â”‚
â”‚ â”‚ - compress_to_webp()                                â”‚ â”‚
â”‚ â”‚ - batch_compress_to_webp()                         â”‚ â”‚
â”‚ â”‚ - WebPCompressOptions                               â”‚ â”‚
â”‚ â”‚ - WebPCompressResult                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ convert/ (è½¬æ¢æ¨¡å—)                                  â”‚ â”‚
â”‚ â”‚ - convert_image_format()                            â”‚ â”‚
â”‚ â”‚ - batch_convert_image_format()                      â”‚ â”‚
â”‚ â”‚ - FormatConversionOptions                           â”‚ â”‚
â”‚ â”‚ - FormatConversionResult                            â”‚ â”‚
â”‚ â”‚ - converters.rs (æ ¼å¼è½¬æ¢å™¨)                         â”‚ â”‚
â”‚ â”‚ - resize.rs (å°ºå¯¸è°ƒæ•´)                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ analyze/ (å›¾ç‰‡åˆ†ææ¨¡å—)                               â”‚ â”‚
â”‚ â”‚ - get_image_info()                                  â”‚ â”‚
â”‚ â”‚ - detect_image_format()                             â”‚ â”‚
â”‚ â”‚ - analyze_dominant_colors()                         â”‚ â”‚
â”‚ â”‚ - analyze_image() (AIåˆ†æ)                          â”‚ â”‚
â”‚ â”‚ - batch_analyze_images()                             â”‚ â”‚
â”‚ â”‚ - check_model_availability()                         â”‚ â”‚
â”‚ â”‚ - ImageAnalysisOptions                               â”‚ â”‚
â”‚ â”‚ - ImageAnalysisResult                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ edit/ (å›¾ç‰‡ç¼–è¾‘æ¨¡å—)                                  â”‚ â”‚
â”‚ â”‚ - crop_image()                                      â”‚ â”‚
â”‚ â”‚ - rotate_image()                                    â”‚ â”‚
â”‚ â”‚ - flip_image()                                      â”‚ â”‚
â”‚ â”‚ - apply_filter()                                    â”‚ â”‚
â”‚ â”‚ - batch_edit_images()                                â”‚ â”‚
â”‚ â”‚ - CropOptions                                       â”‚ â”‚
â”‚ â”‚ - RotateOptions                                     â”‚ â”‚
â”‚ â”‚ - FilterOptions                                     â”‚ â”‚
â”‚ â”‚ - ImageEditResult                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ wasm-pack ç¼–è¯‘             â”‚
        â”‚ - ä½¿ç”¨ #[wasm_bindgen] å® â”‚
        â”‚ - è‡ªåŠ¨ç”Ÿæˆ JS ç»‘å®š         â”‚
        â”‚ - è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ WASM æ¨¡å— (.wasm)          â”‚
        â”‚ - å•ä¸€ .wasm æ–‡ä»¶          â”‚
        â”‚ - è·¨å¹³å°é€šç”¨               â”‚
        â”‚ - æ”¯æŒæ‰€æœ‰æ¶æ„             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“           â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Electron     â”‚ â”‚ Web          â”‚ â”‚ React Native â”‚
â”‚ (PC ç«¯)      â”‚ â”‚ (æµè§ˆå™¨)      â”‚ â”‚ (ç§»åŠ¨ç«¯)     â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ - Node.js    â”‚ â”‚ - æµè§ˆå™¨      â”‚ â”‚ - WASM è¿è¡Œæ—¶â”‚
â”‚   ç¯å¢ƒ       â”‚ â”‚   ç¯å¢ƒ        â”‚ â”‚ - JSI è°ƒç”¨   â”‚
â”‚ - ç›´æ¥åŠ è½½   â”‚ â”‚ - ç›´æ¥åŠ è½½    â”‚ â”‚ - åŸç”Ÿæ€§èƒ½   â”‚
â”‚ - æœ€ä½³æ€§èƒ½   â”‚ â”‚ - Web Worker  â”‚ â”‚ - è·¨å¹³å°     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è¯‘æµç¨‹

#### ç»Ÿä¸€ç¼–è¯‘å‘½ä»¤

```bash
# å®‰è£… wasm-packï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
cargo install wasm-pack

# æ„å»º Web ç‰ˆæœ¬ï¼ˆæµè§ˆå™¨ï¼‰
wasm-pack build --target web --out-dir pkg-web

# æ„å»º Node.js/Electron ç‰ˆæœ¬
wasm-pack build --target nodejs --out-dir pkg-node

# æ„å»º React Native ç‰ˆæœ¬ï¼ˆbundlerï¼‰
wasm-pack build --target bundler --out-dir pkg-mobile

# æˆ–è€…ä½¿ç”¨ç»Ÿä¸€è„šæœ¬ï¼ˆpackage.jsonï¼‰
pnpm run build:wasm        # æ„å»ºæ‰€æœ‰å¹³å°
pnpm run build:wasm:web    # ä»…æ„å»º Web
pnpm run build:wasm:node   # ä»…æ„å»º Node.js
pnpm run build:wasm:mobile # ä»…æ„å»º React Native
```

#### ç¼–è¯‘ç›®æ ‡è¯´æ˜

- **web**ï¼šæµè§ˆå™¨ç¯å¢ƒï¼Œä½¿ç”¨ ES æ¨¡å—ï¼Œé€‚åˆç›´æ¥åœ¨æµè§ˆå™¨ä¸­åŠ è½½
- **nodejs**ï¼šNode.js/Electron ç¯å¢ƒï¼Œä½¿ç”¨ CommonJSï¼Œæ€§èƒ½ä¼˜åŒ–
- **bundler**ï¼šæ‰“åŒ…å·¥å…·ç¯å¢ƒï¼ˆWebpackã€Vite ç­‰ï¼‰ï¼Œé€‚åˆ React
  Native å’Œç°ä»£æ„å»ºå·¥å…·

#### æ™ºèƒ½åŠ è½½é…ç½®ï¼ˆpackage.jsonï¼‰

é€šè¿‡ `exports` å­—æ®µå®ç°æ™ºèƒ½åŠ è½½ï¼Œæ ¹æ®è¿è¡Œç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ¨¡å—ï¼š

```json
{
  "name": "pixuli-wasm",
  "version": "1.0.0",
  "type": "module",
  "exports": {
    ".": {
      "browser": "./pkg-web/pixuli_wasm.js",
      "react-native": "./pkg-mobile/pixuli_wasm.js",
      "node": "./pkg-node/pixuli_wasm.js",
      "default": "./pkg-node/pixuli_wasm.js"
    },
    "./wasm": "./pkg-web/pixuli_wasm.wasm",
    "./wasm-node": "./pkg-node/pixuli_wasm.wasm",
    "./wasm-mobile": "./pkg-mobile/pixuli_wasm.wasm"
  },
  "files": ["pkg-web/**/*", "pkg-node/**/*", "pkg-mobile/**/*"]
}
```

è¿™æ ·ï¼Œç”¨æˆ·åªéœ€
`import pixuliWasm from 'pixuli-wasm'`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®è¿è¡Œç¯å¢ƒé€‰æ‹©æ­£ç¡®çš„æ¨¡å—ã€‚

### æŠ€æœ¯æ ˆ

#### æ ¸å¿ƒä¾èµ–

- **Rust**ï¼šä¸»è¦å¼€å‘è¯­è¨€ï¼Œæä¾›é«˜æ€§èƒ½å’Œå†…å­˜å®‰å…¨
- **wasm-bindgen**ï¼šç”Ÿæˆ WebAssembly å’Œ JavaScript ä¹‹é—´çš„ç»‘å®š
- **image-rs**ï¼šRust å›¾ç‰‡å¤„ç†æ ¸å¿ƒåº“
- **webp**ï¼šWebP æ ¼å¼æ”¯æŒåº“
- **serde**ï¼šåºåˆ—åŒ–æ”¯æŒ
- **ort**ï¼šONNX Runtime ç»‘å®šï¼Œç”¨äº AI åˆ†æï¼ˆéœ€è¦æ¡ä»¶ç¼–è¯‘ï¼Œä»… Node.jsï¼‰
- **ndarray**ï¼šå¤šç»´æ•°ç»„å¤„ç†ï¼Œç”¨äº AI è®¡ç®—

#### æ„å»ºå·¥å…·

- **wasm-pack**ï¼šæ„å»ºå’Œå‘å¸ƒ WASM åŒ…çš„å·¥å…·
- **Cargo**ï¼šRust åŒ…ç®¡ç†å™¨

### é¡¹ç›®ç»“æ„

```
packages/wasm/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              # ä¸»å…¥å£ï¼Œæ¨¡å—å¯¼å‡ºï¼Œä½¿ç”¨ #[wasm_bindgen] å®
â”‚   â”œâ”€â”€ compress/
â”‚   â”‚   â””â”€â”€ mod.rs          # WebP å‹ç¼©å®ç°
â”‚   â”œâ”€â”€ convert/
â”‚   â”‚   â”œâ”€â”€ mod.rs          # æ ¼å¼è½¬æ¢ä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ types.rs        # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ converters.rs   # æ ¼å¼è½¬æ¢å™¨å®ç°
â”‚   â”‚   â””â”€â”€ resize.rs       # å°ºå¯¸è°ƒæ•´é€»è¾‘
â”‚   â”œâ”€â”€ analyze/
â”‚   â”‚   â””â”€â”€ mod.rs          # å›¾ç‰‡åˆ†æå®ç°ï¼ˆåˆå¹¶äº†åŸºç¡€ä¿¡æ¯å’ŒAIåˆ†æï¼‰
â”‚   â””â”€â”€ edit/
â”‚       â”œâ”€â”€ mod.rs          # å›¾ç‰‡ç¼–è¾‘ä¸»é€»è¾‘
â”‚       â”œâ”€â”€ crop.rs         # è£å‰ªå®ç°
â”‚       â”œâ”€â”€ rotate.rs       # æ—‹è½¬å®ç°
â”‚       â”œâ”€â”€ flip.rs         # ç¿»è½¬å®ç°
â”‚       â””â”€â”€ filter.rs       # æ»¤é•œå®ç°
â”œâ”€â”€ Cargo.toml              # Rust ä¾èµ–é…ç½®
â”œâ”€â”€ pkg-web/                # Web ç‰ˆæœ¬æ„å»ºäº§ç‰©ï¼ˆwasm-pack build --target webï¼‰
â”‚   â”œâ”€â”€ pixuli_wasm.wasm    # WASM äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ pixuli_wasm.js      # JavaScript ç»‘å®š
â”‚   â””â”€â”€ pixuli_wasm.d.ts    # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ pkg-node/               # Node.js/Electron ç‰ˆæœ¬æ„å»ºäº§ç‰©ï¼ˆwasm-pack build --target nodejsï¼‰
â”‚   â”œâ”€â”€ pixuli_wasm.wasm    # WASM äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ pixuli_wasm.js      # JavaScript ç»‘å®š
â”‚   â””â”€â”€ pixuli_wasm.d.ts    # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ pkg-mobile/             # React Native ç‰ˆæœ¬æ„å»ºäº§ç‰©ï¼ˆwasm-pack build --target bundlerï¼‰
â”‚   â”œâ”€â”€ pixuli_wasm.wasm    # WASM äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ pixuli_wasm.js      # JavaScript ç»‘å®š
â”‚   â””â”€â”€ pixuli_wasm.d.ts    # TypeScript ç±»å‹å®šä¹‰
â””â”€â”€ package.json            # NPM åŒ…é…ç½®ï¼ˆåŒ…å«æ™ºèƒ½åŠ è½½é…ç½®ï¼‰
```

### ä» NAPI-RS è¿ç§»åˆ° WASMï¼ˆå¯é€‰ï¼‰

å¦‚æœå½“å‰åªéœ€è¦æ”¯æŒ Electronï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ NAPI-RSã€‚å¦‚æœéœ€è¦æ”¯æŒ Web å’Œ React
Nativeï¼Œå¯ä»¥è€ƒè™‘è¿ç§»åˆ° WASMã€‚

#### è¿ç§»æ­¥éª¤

**æ­¥éª¤ 1ï¼šä¿®æ”¹ Cargo.toml**

ä» NAPI ä¾èµ–æ”¹ä¸º wasm-bindgenï¼š

```toml
# ç§»é™¤æˆ–æ³¨é‡Š NAPI ä¾èµ–
# napi = "3.0.0"
# napi-derive = "3.0.0"

# æ·»åŠ  wasm-bindgen ä¾èµ–
[dependencies]
wasm-bindgen = "0.2"
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹ä»£ç ä¸­çš„å®**

å°† `#[napi]` æ”¹ä¸º `#[wasm_bindgen]`ï¼š

```rust
// ä¿®æ”¹å‰ï¼ˆNAPIï¼‰
use napi_derive::napi;

#[napi]
pub fn compress_to_webp(image_data: Vec<u8>, options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    // å®ç°
}

// ä¿®æ”¹åï¼ˆWASMï¼‰
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn compress_to_webp(image_data: &[u8], options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    // å®ç°ï¼ˆæ³¨æ„ï¼šå‚æ•°ç±»å‹å¯èƒ½éœ€è¦è°ƒæ•´ï¼‰
}
```

**æ­¥éª¤ 3ï¼šæ·»åŠ æ„å»ºè„šæœ¬**

åœ¨ package.json ä¸­æ·»åŠ  WASM æ„å»ºè„šæœ¬ï¼ˆè§ä¸‹æ–¹é…ç½®ï¼‰

**æ­¥éª¤ 4ï¼šæµ‹è¯•å’ŒéªŒè¯**

- åœ¨ Node.js ç¯å¢ƒä¸­æµ‹è¯•
- åœ¨ Electron ç¯å¢ƒä¸­æµ‹è¯•
- åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­æµ‹è¯•
- åœ¨ React Native ç¯å¢ƒä¸­æµ‹è¯•

#### æ··åˆæ–¹æ¡ˆï¼ˆä¿æŒ NAPI + æ·»åŠ  WASMï¼‰

å¦‚æœä¸æƒ³å®Œå…¨è¿ç§»ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒ NAPI å’Œ WASMï¼š

**Cargo.toml é…ç½®**ï¼š

```toml
[dependencies]
# NAPI ä¾èµ–ï¼ˆæ¡ä»¶ç¼–è¯‘ï¼‰
napi = { version = "3.0.0", optional = true }
napi-derive = { version = "3.0.0", optional = true }

# WASM ä¾èµ–ï¼ˆæ¡ä»¶ç¼–è¯‘ï¼‰
wasm-bindgen = { version = "0.2", optional = true }

[features]
default = ["napi"]
napi = ["napi", "napi-derive"]
wasm = ["wasm-bindgen"]
```

**ä»£ç ä¸­ä½¿ç”¨æ¡ä»¶ç¼–è¯‘**ï¼š

```rust
#[cfg(feature = "napi")]
use napi_derive::napi;

#[cfg(feature = "wasm")]
use wasm_bindgen::prelude::*;

#[cfg(feature = "napi")]
#[napi]
pub fn compress_to_webp(image_data: Vec<u8>, options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    compress_to_webp_impl(image_data, options)
}

#[cfg(feature = "wasm")]
#[wasm_bindgen]
pub fn compress_to_webp(image_data: &[u8], options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    compress_to_webp_impl(image_data.to_vec(), options)
}

// å…±äº«å®ç°
fn compress_to_webp_impl(image_data: Vec<u8>, options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    // å®é™…å®ç°é€»è¾‘
}
```

**æ„å»ºå‘½ä»¤**ï¼š

```bash
# æ„å»º NAPI ç‰ˆæœ¬ï¼ˆElectron/Node.jsï¼‰
napi build --platform --release

# æ„å»º WASM ç‰ˆæœ¬ï¼ˆWeb/React Nativeï¼‰
wasm-pack build --target web --out-dir pkg-web --release
wasm-pack build --target nodejs --out-dir pkg-node --release
wasm-pack build --target bundler --out-dir pkg-mobile --release
```

### ç»Ÿä¸€æ„å»ºæ–¹æ¡ˆè¯¦ç»†è¯´æ˜ï¼ˆWASMï¼‰

#### 1. Cargo.toml é…ç½®

```toml
[package]
name = "pixuli_wasm"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
wasm-bindgen = "0.2"
image = { version = "0.24", features = ["jpeg", "png", "gif", "bmp", "tiff"] }
webp = "0.2"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# æ¡ä»¶ç¼–è¯‘ï¼šONNX Runtime ä»…ç”¨äº Node.jsï¼ˆé€šè¿‡ feature flagï¼‰
[target.'cfg(not(target_arch = "wasm32"))'.dependencies]
ort = { version = "1.16", optional = true }

[features]
default = []
onnx = ["ort"]
```

#### 2. package.json é…ç½®ï¼ˆæ™ºèƒ½åŠ è½½ï¼‰

```json
{
  "name": "pixuli-wasm",
  "version": "1.0.0",
  "type": "module",
  "main": "./pkg-node/pixuli_wasm.js",
  "types": "./pkg-node/pixuli_wasm.d.ts",
  "exports": {
    ".": {
      "browser": {
        "import": "./pkg-web/pixuli_wasm.js",
        "require": "./pkg-web/pixuli_wasm.js"
      },
      "react-native": "./pkg-mobile/pixuli_wasm.js",
      "node": "./pkg-node/pixuli_wasm.js",
      "default": "./pkg-node/pixuli_wasm.js"
    },
    "./wasm": "./pkg-web/pixuli_wasm.wasm",
    "./wasm-node": "./pkg-node/pixuli_wasm.wasm",
    "./wasm-mobile": "./pkg-mobile/pixuli_wasm.wasm"
  },
  "files": ["pkg-web/**/*", "pkg-node/**/*", "pkg-mobile/**/*"],
  "scripts": {
    "build": "npm run build:wasm",
    "build:wasm": "npm run build:wasm:web && npm run build:wasm:node && npm run build:wasm:mobile",
    "build:wasm:web": "wasm-pack build --target web --out-dir pkg-web --release",
    "build:wasm:node": "wasm-pack build --target nodejs --out-dir pkg-node --release",
    "build:wasm:mobile": "wasm-pack build --target bundler --out-dir pkg-mobile --release",
    "build:wasm:dev": "wasm-pack build --target web --out-dir pkg-web --dev",
    "clean": "rm -rf pkg-web pkg-node pkg-mobile"
  }
}
```

#### 3. ä½¿ç”¨ç¤ºä¾‹

**åœ¨æ‰€æœ‰å¹³å°ä¸­ä½¿ç”¨ç›¸åŒçš„ä»£ç **ï¼š

```javascript
// Electronã€Webã€React Native éƒ½ä½¿ç”¨ç›¸åŒçš„å¯¼å…¥è¯­å¥
import init, { compress_to_webp, convert_image_format } from 'pixuli-wasm';

// åˆå§‹åŒ–ï¼ˆå¼‚æ­¥ï¼‰
await init();

// ä½¿ç”¨åŠŸèƒ½
const result = await compress_to_webp(imageData, { quality: 80 });
```

**Electron ä¸­ä½¿ç”¨**ï¼š

```javascript
// main.js (ä¸»è¿›ç¨‹)
import init, { compress_to_webp } from 'pixuli-wasm';

await init(); // åˆå§‹åŒ– WASM æ¨¡å—

// å¤„ç†å›¾ç‰‡å‹ç¼©
ipcMain.handle('compress-image', async (event, imageData, options) => {
  return await compress_to_webp(imageData, options);
});
```

**Web ä¸­ä½¿ç”¨**ï¼š

```javascript
// browser.js
import init, { compress_to_webp } from 'pixuli-wasm';

await init(); // åˆå§‹åŒ– WASM æ¨¡å—

// åœ¨ Web Worker ä¸­ä½¿ç”¨ï¼ˆæ¨èï¼‰
// worker.js
import init, { compress_to_webp } from 'pixuli-wasm';

self.onmessage = async e => {
  await init();
  const result = await compress_to_webp(e.data.imageData, e.data.options);
  self.postMessage(result);
};
```

**React Native ä¸­ä½¿ç”¨**ï¼š

```javascript
// App.js
import { useEffect, useState } from 'react';
import init, { compress_to_webp } from 'pixuli-wasm';

function App() {
  const [wasmReady, setWasmReady] = useState(false);

  useEffect(() => {
    // åˆå§‹åŒ– WASM æ¨¡å—
    init().then(() => {
      setWasmReady(true);
    });
  }, []);

  const handleCompress = async (imageUri) => {
    if (!wasmReady) return;

    // è¯»å–å›¾ç‰‡æ•°æ®
    const response = await fetch(imageUri);
    const imageData = await response.arrayBuffer();

    // å‹ç¼©å›¾ç‰‡
    const result = await compress_to_webp(
      new Uint8Array(imageData),
      { quality: 80 }
    );

    return result;
  };

  return (
    // UI ä»£ç 
  );
}
```

#### 4. æ„å»ºæµç¨‹

```bash
# 1. å®‰è£…ä¾èµ–
cargo install wasm-pack

# 2. æ„å»ºæ‰€æœ‰å¹³å°
pnpm run build:wasm

# 3. æˆ–è€…åˆ†åˆ«æ„å»º
pnpm run build:wasm:web    # Web ç‰ˆæœ¬
pnpm run build:wasm:node   # Node.js/Electron ç‰ˆæœ¬
pnpm run build:wasm:mobile # React Native ç‰ˆæœ¬

# 4. å‘å¸ƒåˆ° npm
npm publish
```

#### 5. ä¼˜åŠ¿æ€»ç»“

- âœ… **ä¸€å¥—ä»£ç **ï¼šåªéœ€ç»´æŠ¤ä¸€å¥— Rust ä»£ç 
- âœ… **ç»Ÿä¸€æ„å»º**ï¼šä½¿ç”¨ `wasm-pack build` å³å¯
- âœ… **æ™ºèƒ½åŠ è½½**ï¼špackage.json è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ¨¡å—
- âœ… **æ‰€æœ‰å¹³å°**ï¼šReact Nativeã€Webã€Electron å…¨éƒ¨æ”¯æŒ
- âœ… **ç®€å•ä½¿ç”¨**ï¼šæ‰€æœ‰å¹³å°ä½¿ç”¨ç›¸åŒçš„å¯¼å…¥è¯­å¥
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šWASM æ€§èƒ½çº¦ä¸ºåŸç”Ÿä»£ç çš„ 80-90%

---

## ğŸš€ åº”ç”¨åœºæ™¯

### 1. å›¾ç‰‡å‹ç¼©åœºæ™¯

- **ä¸Šä¼ å‰å‹ç¼©**ï¼šåœ¨ä¸Šä¼ åˆ°äº‘ç«¯å‰å‹ç¼©å›¾ç‰‡ï¼Œå‡å°‘ä¸Šä¼ æ—¶é—´å’Œå­˜å‚¨ç©ºé—´
- **æ‰¹é‡å‹ç¼©**ï¼šæ‰¹é‡å¤„ç†å¤§é‡å›¾ç‰‡ï¼Œæé«˜å¤„ç†æ•ˆç‡
- **è´¨é‡ä¼˜åŒ–**ï¼šæ ¹æ®éœ€æ±‚è°ƒæ•´å‹ç¼©è´¨é‡ï¼Œå¹³è¡¡æ–‡ä»¶å¤§å°å’Œå›¾ç‰‡è´¨é‡

### 2. æ ¼å¼è½¬æ¢åœºæ™¯

- **æ ¼å¼ç»Ÿä¸€**ï¼šå°†ä¸åŒæ ¼å¼çš„å›¾ç‰‡è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
- **å…¼å®¹æ€§å¤„ç†**ï¼šè½¬æ¢ä¸ºæ›´å…¼å®¹çš„æ ¼å¼ï¼ˆå¦‚ WebP è½¬ JPEGï¼‰
- **å°ºå¯¸è°ƒæ•´**ï¼šåœ¨è½¬æ¢æ—¶åŒæ—¶è°ƒæ•´å›¾ç‰‡å°ºå¯¸

### 3. å›¾ç‰‡åˆ†æåœºæ™¯

- **ä¿¡æ¯è·å–**ï¼šå¿«é€Ÿè·å–å›¾ç‰‡åŸºæœ¬ä¿¡æ¯ï¼ˆå°ºå¯¸ã€æ ¼å¼ç­‰ï¼‰
- **è‡ªåŠ¨æ ‡ç­¾**ï¼šè‡ªåŠ¨ä¸ºå›¾ç‰‡ç”Ÿæˆæ ‡ç­¾ï¼Œä¾¿äºåˆ†ç±»å’Œæœç´¢
- **å†…å®¹è¯†åˆ«**ï¼šè¯†åˆ«å›¾ç‰‡ä¸­çš„å¯¹è±¡å’Œåœºæ™¯
- **æ™ºèƒ½æè¿°**ï¼šç”Ÿæˆå›¾ç‰‡æè¿°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 4. å›¾ç‰‡ç¼–è¾‘åœºæ™¯

- **å¿«é€Ÿè£å‰ª**ï¼šåœ¨åº”ç”¨ä¸­å¿«é€Ÿè£å‰ªå›¾ç‰‡
- **æ—‹è½¬è°ƒæ•´**ï¼šè°ƒæ•´å›¾ç‰‡æ–¹å‘
- **æ»¤é•œåº”ç”¨**ï¼šåº”ç”¨å„ç§æ»¤é•œæ•ˆæœï¼Œç¾åŒ–å›¾ç‰‡
- **æ‰¹é‡ç¼–è¾‘**ï¼šæ‰¹é‡åº”ç”¨ç›¸åŒçš„ç¼–è¾‘æ“ä½œ

### 5. æ€§èƒ½ä¼˜åŒ–åœºæ™¯

- **æ‰¹é‡å¤„ç†**ï¼šä½¿ç”¨æ‰¹é‡ API å‡å°‘è°ƒç”¨æ¬¡æ•°
- **å¹¶å‘å¤„ç†**ï¼šåœ¨ Node.js ä¸»è¿›ç¨‹æˆ– Electron ä¸»è¿›ç¨‹ä¸­å¹¶å‘å¤„ç†å¤šå¼ å›¾ç‰‡
- **å†…å­˜ä¼˜åŒ–**ï¼šæµå¼å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡å›¾ç‰‡åˆ°å†…å­˜

---

## âš™ï¸ æ€§èƒ½ç‰¹ç‚¹

### å‹ç¼©æ€§èƒ½

- **å‹ç¼©ç‡**ï¼šWebP æ¯” JPEG å° 25-35%ï¼Œæ¯” PNG å° 25-50%
- **å¤„ç†é€Ÿåº¦**ï¼šå•å¼  2MB å›¾ç‰‡å‹ç¼©æ—¶é—´å°äº 100ms
- **å†…å­˜å ç”¨**ï¼šæµå¼å¤„ç†ï¼Œå†…å­˜å ç”¨ä½
- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒå¹¶å‘å¤„ç†ï¼Œæé«˜ååé‡

### æ ¼å¼è½¬æ¢æ€§èƒ½

- **æ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒ 6 ç§ä¸»æµæ ¼å¼æ— ç¼è½¬æ¢
- **æ™ºèƒ½ä¼˜åŒ–**ï¼šæ ¹æ®ç›®æ ‡æ ¼å¼è‡ªåŠ¨ä¼˜åŒ–å‚æ•°
- **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¹¶å‘å¤„ç†å¤šå¼ å›¾ç‰‡

### å›¾ç‰‡åˆ†ææ€§èƒ½

- **åŸºç¡€åˆ†æ**ï¼šå›¾ç‰‡ä¿¡æ¯è·å–é€Ÿåº¦ < 10ms
- **AI åˆ†æ**ï¼šæ”¯æŒ ONNX Runtime æ¨¡å‹
- **GPU åŠ é€Ÿ**ï¼šæ”¯æŒ GPU åŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
- **æ‰¹é‡åˆ†æ**ï¼šæ”¯æŒæ‰¹é‡å›¾ç‰‡åˆ†æ

### å›¾ç‰‡ç¼–è¾‘æ€§èƒ½

- **ç¼–è¾‘é€Ÿåº¦**ï¼šå•å¼  2MB å›¾ç‰‡ç¼–è¾‘æ—¶é—´ < 200ms
- **æ»¤é•œå¤„ç†**ï¼šå®æ—¶æ»¤é•œé¢„è§ˆæ”¯æŒ
- **æ‰¹é‡ç¼–è¾‘**ï¼šæ”¯æŒæ‰¹é‡åº”ç”¨ç¼–è¾‘æ“ä½œ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¹³å°æ”¯æŒ

#### å½“å‰å®ç°ï¼ˆNAPI-RSï¼‰

- **Electronï¼ˆPC ç«¯ï¼‰**ï¼šâœ… å®Œç¾æ”¯æŒï¼ŒåŸç”Ÿæ¨¡å—æ€§èƒ½æœ€ä¼˜
- **Node.js åç«¯**ï¼šâœ… å®Œç¾æ”¯æŒï¼ŒåŸç”Ÿæ¨¡å—æ€§èƒ½æœ€ä¼˜
- **Webï¼ˆæµè§ˆå™¨ï¼‰**ï¼šâŒ ä¸æ”¯æŒï¼Œéœ€è¦é€šè¿‡ Electron åŒ…è£…
- **React Nativeï¼ˆç§»åŠ¨ç«¯ï¼‰**ï¼šâŒ ä¸æ”¯æŒï¼Œéœ€è¦é¢å¤– WASM æ”¯æŒ

#### WASM ç»Ÿä¸€æ–¹æ¡ˆä¼˜åŠ¿ï¼ˆæ¨èè¿ç§»ï¼‰

- **ç»Ÿä¸€æ„å»º**ï¼šåªéœ€ç»´æŠ¤ä¸€å¥— Rust ä»£ç 
- **æ‰€æœ‰å¹³å°æ”¯æŒ**ï¼šReact Nativeã€Webã€Electron å…¨éƒ¨æ”¯æŒ
- **æ™ºèƒ½åŠ è½½**ï¼šé€šè¿‡ package.json çš„ exports å­—æ®µè‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ¨¡å—
- **è·¨å¹³å°å…¼å®¹**ï¼šWASM æ˜¯ Web æ ‡å‡†ï¼Œæ‰€æœ‰ç°ä»£ç¯å¢ƒéƒ½æ”¯æŒ
- **æ„å»ºç®€å•**ï¼šåªéœ€ `wasm-pack build` å‘½ä»¤

#### å¹³å°æ”¯æŒè¯¦æƒ…ï¼ˆWASM æ–¹æ¡ˆï¼‰

- **Electronï¼ˆPC ç«¯ï¼‰**ï¼šâœ… å®Œç¾æ”¯æŒï¼Œé€šè¿‡ Node.js ç¯å¢ƒåŠ è½½ WASMï¼ˆæ€§èƒ½çº¦ä¸º NAPI çš„ 80-90%ï¼‰
- **Webï¼ˆæµè§ˆå™¨ï¼‰**ï¼šâœ… å®Œç¾æ”¯æŒï¼Œç›´æ¥åŠ è½½ WASM æ¨¡å—
- **React Nativeï¼ˆç§»åŠ¨ç«¯ï¼‰**ï¼šâœ… æ”¯æŒï¼Œé€šè¿‡ WASM è¿è¡Œæ—¶åŠ è½½

#### Web ç«¯å’Œç§»åŠ¨ç«¯ä½¿ç”¨æ–¹æ¡ˆ

è™½ç„¶ NAPI ç¼–è¯‘çš„ `.node`
æ¨¡å—ä¸èƒ½ç›´æ¥åœ¨ Web ç«¯å’Œç§»åŠ¨ç«¯ä½¿ç”¨ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

**æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ Electron/Node.js æ¡¥æ¥ï¼ˆæ¨èï¼‰**

- **Web ç«¯**ï¼šé€šè¿‡ Electron ä¸»è¿›ç¨‹è°ƒç”¨ NAPI æ¨¡å—ï¼Œæ¸²æŸ“è¿›ç¨‹é€šè¿‡ IPC é€šä¿¡
- **ç§»åŠ¨ç«¯**ï¼šé€šè¿‡ Node.js åç«¯æœåŠ¡è°ƒç”¨ NAPI æ¨¡å—ï¼Œç§»åŠ¨ç«¯é€šè¿‡ HTTP API è°ƒç”¨

**æ–¹æ¡ˆäºŒï¼šç¼–è¯‘ä¸º WASMï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰**

- **Web ç«¯**ï¼šä½¿ç”¨ `wasm-bindgen` ç¼–è¯‘ä¸º WASMï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
- **ç§»åŠ¨ç«¯**ï¼šä½¿ç”¨ `wasm-bindgen` ç¼–è¯‘ä¸º WASMï¼Œåœ¨ React
  Native çš„ WASM è¿è¡Œæ—¶ä¸­è¿è¡Œ

**æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ–¹æ¡ˆ**

- Node.js/Electron ç¯å¢ƒï¼šä½¿ç”¨ NAPI ç¼–è¯‘çš„ `.node` æ¨¡å—ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- Web/ç§»åŠ¨ç«¯ï¼šä½¿ç”¨ WASM ç¼–è¯‘çš„ `.wasm` æ¨¡å—ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰

### 2. å†…å­˜ç®¡ç†

- **å¤§æ–‡ä»¶å¤„ç†**ï¼šå¯¹äºè¶…å¤§æ–‡ä»¶ï¼Œè€ƒè™‘åˆ†å—å¤„ç†æˆ–æµå¼å¤„ç†
- **å†…å­˜é™åˆ¶**ï¼šæ³¨æ„å†…å­˜ä½¿ç”¨ï¼Œé¿å…å¤„ç†è¿‡å¤šå¤§æ–‡ä»¶å¯¼è‡´å†…å­˜æº¢å‡º
- **åŠæ—¶é‡Šæ”¾**ï¼šå¤„ç†å®ŒæˆååŠæ—¶é‡Šæ”¾å†…å­˜

### 3. é”™è¯¯å¤„ç†

- **è¾“å…¥éªŒè¯**ï¼šéªŒè¯è¾“å…¥æ•°æ®æ ¼å¼å’Œå¤§å°
- **é”™è¯¯æ•è·**ï¼šæ‰€æœ‰å‡½æ•°éƒ½åº”åŒ…å«é”™è¯¯å¤„ç†
- **é”™è¯¯ä¿¡æ¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

### 4. æ•°æ®è½¬æ¢

- **ç±»å‹è½¬æ¢**ï¼šNAPI-RS è‡ªåŠ¨å¤„ç† Rust ç±»å‹å’Œ JavaScript ç±»å‹ä¹‹é—´çš„è½¬æ¢
- **æ•°æ®æ‹·è´**ï¼šå¤§æ–‡ä»¶ä¼ é€’æ—¶æ³¨æ„æ•°æ®æ‹·è´å¼€é”€
- **åºåˆ—åŒ–**ï¼šå¤æ‚æ•°æ®ç»“æ„éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–

### 5. æ„å»ºé…ç½®

- **å¤šå¹³å°æ„å»º**ï¼šNAPI-RS è‡ªåŠ¨ä¸ºé…ç½®çš„å¹³å°æ„å»º
- **ä¾èµ–ç®¡ç†**ï¼šæ³¨æ„å¹³å°ç‰¹å®šçš„ä¾èµ–ï¼ˆå¦‚ ONNX Runtime åº“ï¼‰
- **æµ‹è¯•**ï¼šåœ¨ä¸åŒå¹³å°ä¸Šæµ‹è¯•åŠŸèƒ½

### 6. æ€§èƒ½ä¼˜åŒ–

- **ç¼–è¯‘ä¼˜åŒ–**ï¼šä½¿ç”¨ release æ¨¡å¼ç¼–è¯‘ï¼Œå¯ç”¨ LTO
- **ç®—æ³•ä¼˜åŒ–**ï¼šé€‰æ‹©é«˜æ•ˆçš„å›¾ç‰‡å¤„ç†ç®—æ³•
- **å¹¶å‘å¤„ç†**ï¼šåˆç†ä½¿ç”¨å¹¶å‘ï¼Œé¿å…è¿‡åº¦å¹¶å‘å¯¼è‡´èµ„æºç«äº‰

### 7. å®‰å…¨æ€§

- **è¾“å…¥éªŒè¯**ï¼šéªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®ï¼Œé˜²æ­¢æ¶æ„æ•°æ®
- **è¾¹ç•Œæ£€æŸ¥**ï¼šæ£€æŸ¥æ•°ç»„è¾¹ç•Œï¼Œé˜²æ­¢ç¼“å†²åŒºæº¢å‡º
- **èµ„æºé™åˆ¶**ï¼šé™åˆ¶å¤„ç†æ–‡ä»¶å¤§å°å’Œæ•°é‡

### 8. æµ‹è¯•

- **å•å…ƒæµ‹è¯•**ï¼šä¸ºæ¯ä¸ªå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•
- **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•ä¸ Node.js/Electron çš„é›†æˆ
- **æ€§èƒ½æµ‹è¯•**ï¼šå»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•
- **è¾¹ç•Œæµ‹è¯•**ï¼šæµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸æƒ…å†µ

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å‹ç¼©æ€§èƒ½æŒ‡æ ‡

- **å‹ç¼©ç‡**ï¼šWebP å¹³å‡å‹ç¼©ç‡ 30-50%
- **å¤„ç†é€Ÿåº¦**ï¼š2MB å›¾ç‰‡å‹ç¼©æ—¶é—´ < 100ms
- **å†…å­˜å ç”¨**ï¼šå•å¼ å›¾ç‰‡å¤„ç†å†…å­˜å ç”¨ < 50MB
- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒ 100+ å›¾ç‰‡å¹¶å‘å¤„ç†

### æ ¼å¼è½¬æ¢æ€§èƒ½æŒ‡æ ‡

- **è½¬æ¢é€Ÿåº¦**ï¼š2MB å›¾ç‰‡è½¬æ¢æ—¶é—´ < 150ms
- **æ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒ 6 ç§ä¸»æµæ ¼å¼
- **è´¨é‡ä¿æŒ**ï¼šè½¬æ¢åè´¨é‡æŸå¤± < 5%

### å›¾ç‰‡åˆ†ææ€§èƒ½æŒ‡æ ‡

- **åŸºç¡€åˆ†æé€Ÿåº¦**ï¼šå›¾ç‰‡ä¿¡æ¯è·å–æ—¶é—´ < 10ms
- **AI åˆ†æé€Ÿåº¦**ï¼šå•å¼ å›¾ç‰‡åˆ†ææ—¶é—´ < 500msï¼ˆCPUï¼‰
- **å‡†ç¡®ç‡**ï¼šåŸºç¡€åˆ†æå‡†ç¡®ç‡ 75%+
- **GPU åŠ é€Ÿ**ï¼šä½¿ç”¨ GPU æ—¶é€Ÿåº¦æå‡ 5-10 å€

### å›¾ç‰‡ç¼–è¾‘æ€§èƒ½æŒ‡æ ‡

- **ç¼–è¾‘é€Ÿåº¦**ï¼š2MB å›¾ç‰‡ç¼–è¾‘æ—¶é—´ < 200ms
- **æ»¤é•œå¤„ç†**ï¼šå®æ—¶æ»¤é•œé¢„è§ˆå»¶è¿Ÿ < 50ms
- **æ‰¹é‡ç¼–è¾‘**ï¼šæ”¯æŒ 50+ å›¾ç‰‡æ‰¹é‡ç¼–è¾‘

---

## ğŸ”’ å®‰å…¨æ€§è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

- **æ•°æ®æ ¼å¼**ï¼šéªŒè¯è¾“å…¥æ•°æ®æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼
- **æ•°æ®å¤§å°**ï¼šé™åˆ¶è¾“å…¥æ•°æ®å¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
- **å‚æ•°èŒƒå›´**ï¼šéªŒè¯å‚æ•°èŒƒå›´ï¼ˆå¦‚è´¨é‡ 0-100ã€è§’åº¦èŒƒå›´ç­‰ï¼‰

### 2. å†…å­˜å®‰å…¨

- **Rust å†…å­˜å®‰å…¨**ï¼šåˆ©ç”¨ Rust çš„æ‰€æœ‰æƒç³»ç»Ÿç¡®ä¿å†…å­˜å®‰å…¨
- **è¾¹ç•Œæ£€æŸ¥**ï¼šæ‰€æœ‰æ•°ç»„è®¿é—®éƒ½è¿›è¡Œè¾¹ç•Œæ£€æŸ¥
- **èµ„æºç®¡ç†**ï¼šä½¿ç”¨ RAII è‡ªåŠ¨ç®¡ç†èµ„æº

### 3. é”™è¯¯å¤„ç†

- **é”™è¯¯ç±»å‹**ï¼šä½¿ç”¨ Result ç±»å‹å¤„ç†é”™è¯¯
- **é”™è¯¯ä¼ æ’­**ï¼šNAPI-RS è‡ªåŠ¨å°† Rust é”™è¯¯è½¬æ¢ä¸º JavaScript é”™è¯¯
- **é”™è¯¯ä¿¡æ¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. ä»£ç ç»„ç»‡

- **æ¨¡å—åŒ–**ï¼šæŒ‰åŠŸèƒ½å°†ä»£ç ç»„ç»‡åˆ°ä¸åŒæ¨¡å—
- **å¯å¤ç”¨**ï¼šæå–å…¬å…±é€»è¾‘ä¸ºå¯å¤ç”¨å‡½æ•°
- **æ–‡æ¡£åŒ–**ï¼šä¸ºå…¬å…± API ç¼–å†™æ–‡æ¡£æ³¨é‡Š

### 2. é”™è¯¯å¤„ç†

- **ç»Ÿä¸€é”™è¯¯ç±»å‹**ï¼šä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ç±»å‹
- **é”™è¯¯è½¬æ¢**ï¼šNAPI-RS è‡ªåŠ¨å°† Rust é”™è¯¯è½¬æ¢ä¸º JavaScript é”™è¯¯
- **é”™è¯¯ä¿¡æ¯**ï¼šæä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

### 3. æ€§èƒ½ä¼˜åŒ–

- **ç®—æ³•é€‰æ‹©**ï¼šé€‰æ‹©é«˜æ•ˆçš„ç®—æ³•å’Œæ•°æ®ç»“æ„
- **å†…å­˜ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…
- **å¹¶å‘ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨å¹¶å‘ï¼Œæé«˜å¤„ç†æ•ˆç‡

### 4. æµ‹è¯•

- **å•å…ƒæµ‹è¯•**ï¼šä¸ºæ¯ä¸ªå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•
- **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•ä¸ Node.js/Electron çš„é›†æˆ
- **æ€§èƒ½æµ‹è¯•**ï¼šå»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ“ˆ æœªæ¥æ‰©å±•

### åŠŸèƒ½æ‰©å±•

- **æ›´å¤šæ ¼å¼**ï¼šæ”¯æŒæ›´å¤šå›¾ç‰‡æ ¼å¼ï¼ˆAVIFã€HEIC ç­‰ï¼‰
- **æ›´å¤š AI æ¨¡å‹**ï¼šæ”¯æŒæ›´å¤š AI æ¨¡å‹ï¼ˆYOLOã€CLIP ç­‰ï¼‰
- **æ›´å¤šæ»¤é•œ**ï¼šæ·»åŠ æ›´å¤šæ»¤é•œæ•ˆæœ
- **è§†é¢‘å¤„ç†**ï¼šæ”¯æŒè§†é¢‘å¤„ç†å’Œè½¬æ¢

### æ€§èƒ½ä¼˜åŒ–

- **SIMD ä¼˜åŒ–**ï¼šä½¿ç”¨ SIMD æŒ‡ä»¤åŠ é€Ÿè®¡ç®—
- **GPU åŠ é€Ÿ**ï¼šæ›´å¤šåŠŸèƒ½æ”¯æŒ GPU åŠ é€Ÿ
- **å¹¶è¡Œå¤„ç†**ï¼šä¼˜åŒ–å¹¶è¡Œå¤„ç†èƒ½åŠ›

### å¼€å‘ä½“éªŒ

- **ç±»å‹ç”Ÿæˆ**ï¼šNAPI-RS è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰
- **æ–‡æ¡£ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
- **æµ‹è¯•å·¥å…·**ï¼šæä¾›æµ‹è¯•å·¥å…·å’Œç¤ºä¾‹

---

## ğŸŒ Web ç«¯å’Œç§»åŠ¨ç«¯ä½¿ç”¨æŒ‡å—

### é‡è¦è¯´æ˜

**NAPI ç¼–è¯‘çš„ `.node` æ¨¡å—é™åˆ¶**ï¼š

- `.node` æ¨¡å—æ˜¯ Node.js åŸç”Ÿæ¨¡å—ï¼Œåªèƒ½åœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œ
- ä¸èƒ½ç›´æ¥åœ¨æµè§ˆå™¨æˆ– React Native ä¸­åŠ è½½å’Œè¿è¡Œ
- éœ€è¦é€šè¿‡æ¡¥æ¥æˆ–ç¼–è¯‘ä¸º WASM çš„æ–¹å¼ä½¿ç”¨

### æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ Electron æ¡¥æ¥ï¼ˆWeb ç«¯ï¼‰

å¦‚æœ Web åº”ç”¨è¿è¡Œåœ¨ Electron ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸»è¿›ç¨‹æ¡¥æ¥çš„æ–¹å¼ä½¿ç”¨ NAPI æ¨¡å—ï¼š

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Electron æ¸²æŸ“è¿›ç¨‹ (Web UI)              â”‚
â”‚ - ä½¿ç”¨æ ‡å‡† Web API                      â”‚
â”‚ - é€šè¿‡ IPC ä¸ä¸»è¿›ç¨‹é€šä¿¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Electron ä¸»è¿›ç¨‹                         â”‚
â”‚ - åŠ è½½ NAPI æ¨¡å— (.node)                â”‚
â”‚ - å¤„ç†å›¾ç‰‡å¤„ç†è¯·æ±‚                      â”‚
â”‚ - è¿”å›å¤„ç†ç»“æœ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAPI æ¨¡å— (pixuli-wasm.node)            â”‚
â”‚ - é«˜æ€§èƒ½å›¾ç‰‡å¤„ç†                        â”‚
â”‚ - åŸç”Ÿæ€§èƒ½                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°ç¤ºä¾‹

**ä¸»è¿›ç¨‹ä»£ç ï¼ˆmain.jsï¼‰**ï¼š

```javascript
const { ipcMain } = require('electron');
const pixuliWasm = require('pixuli-wasm');

// å¤„ç†å›¾ç‰‡å‹ç¼©è¯·æ±‚
ipcMain.handle('compress-image', async (event, imageData, options) => {
  try {
    const result = await pixuliWasm.compressToWebp(imageData, options);
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
});

// å¤„ç†å›¾ç‰‡è½¬æ¢è¯·æ±‚
ipcMain.handle('convert-image', async (event, imageData, options) => {
  try {
    const result = await pixuliWasm.convertImageFormat(imageData, options);
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```

**æ¸²æŸ“è¿›ç¨‹ä»£ç ï¼ˆrenderer.jsï¼‰**ï¼š

```javascript
const { ipcRenderer } = require('electron');

// è°ƒç”¨å›¾ç‰‡å‹ç¼©
async function compressImage(imageFile, options) {
  const imageData = await imageFile.arrayBuffer();
  const result = await ipcRenderer.invoke('compress-image', imageData, options);

  if (result.success) {
    return result.data;
  } else {
    throw new Error(result.error);
  }
}

// è°ƒç”¨å›¾ç‰‡è½¬æ¢
async function convertImage(imageFile, options) {
  const imageData = await imageFile.arrayBuffer();
  const result = await ipcRenderer.invoke('convert-image', imageData, options);

  if (result.success) {
    return result.data;
  } else {
    throw new Error(result.error);
  }
}
```

#### ä¼˜åŠ¿

- **åŸç”Ÿæ€§èƒ½**ï¼šä½¿ç”¨ NAPI æ¨¡å—ï¼Œæ€§èƒ½æœ€ä¼˜
- **ç»Ÿä¸€ä»£ç **ï¼šåªéœ€ç»´æŠ¤ä¸€å¥— Rust ä»£ç 
- **ç®€å•é›†æˆ**ï¼šé€šè¿‡ Electron IPC å³å¯ä½¿ç”¨

#### é™åˆ¶

- **ä»…é™ Electron**ï¼šåªèƒ½åœ¨ Electron åº”ç”¨ä¸­ä½¿ç”¨
- **IPC å¼€é”€**ï¼šéœ€è¦è¿›ç¨‹é—´é€šä¿¡ï¼Œæœ‰ä¸€å®šæ€§èƒ½å¼€é”€

### æ–¹æ¡ˆäºŒï¼šé€šè¿‡ Node.js åç«¯æœåŠ¡ï¼ˆç§»åŠ¨ç«¯ï¼‰

å¦‚æœç§»åŠ¨ç«¯åº”ç”¨éœ€è¦å›¾ç‰‡å¤„ç†åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ Node.js åç«¯æœåŠ¡æä¾› APIï¼š

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React Native ç§»åŠ¨ç«¯                     â”‚
â”‚ - å‘é€ HTTP è¯·æ±‚                        â”‚
â”‚ - æ¥æ”¶å¤„ç†ç»“æœ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node.js åç«¯æœåŠ¡                        â”‚
â”‚ - Express/Koa æœåŠ¡å™¨                    â”‚
â”‚ - åŠ è½½ NAPI æ¨¡å—                        â”‚
â”‚ - æä¾› REST API                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAPI æ¨¡å— (pixuli-wasm.node)            â”‚
â”‚ - é«˜æ€§èƒ½å›¾ç‰‡å¤„ç†                        â”‚
â”‚ - åŸç”Ÿæ€§èƒ½                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°ç¤ºä¾‹

**åç«¯æœåŠ¡ä»£ç ï¼ˆserver.jsï¼‰**ï¼š

```javascript
const express = require('express');
const multer = require('multer');
const pixuliWasm = require('pixuli-wasm');

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

// å›¾ç‰‡å‹ç¼© API
app.post('/api/compress', upload.single('image'), async (req, res) => {
  try {
    const imageData = req.file.buffer;
    const options = JSON.parse(req.body.options || '{}');

    const result = await pixuliWasm.compressToWebp(imageData, options);
    res.json({ success: true, data: result });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

// å›¾ç‰‡è½¬æ¢ API
app.post('/api/convert', upload.single('image'), async (req, res) => {
  try {
    const imageData = req.file.buffer;
    const options = JSON.parse(req.body.options || '{}');

    const result = await pixuliWasm.convertImageFormat(imageData, options);
    res.json({ success: true, data: result });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

**ç§»åŠ¨ç«¯ä»£ç ï¼ˆReact Nativeï¼‰**ï¼š

```javascript
import { uploadImage } from './api';

// è°ƒç”¨å›¾ç‰‡å‹ç¼©
async function compressImage(imageUri, options) {
  const formData = new FormData();
  formData.append('image', {
    uri: imageUri,
    type: 'image/jpeg',
    name: 'image.jpg',
  });
  formData.append('options', JSON.stringify(options));

  const response = await fetch('http://your-server:3000/api/compress', {
    method: 'POST',
    body: formData,
  });

  const result = await response.json();
  if (result.success) {
    return result.data;
  } else {
    throw new Error(result.error);
  }
}
```

#### ä¼˜åŠ¿

- **åŸç”Ÿæ€§èƒ½**ï¼šåç«¯ä½¿ç”¨ NAPI æ¨¡å—ï¼Œæ€§èƒ½æœ€ä¼˜
- **ç»Ÿä¸€ä»£ç **ï¼šåªéœ€ç»´æŠ¤ä¸€å¥— Rust ä»£ç 
- **çµæ´»éƒ¨ç½²**ï¼šåç«¯å¯ä»¥éƒ¨ç½²åœ¨æœåŠ¡å™¨æˆ–æœ¬åœ°

#### é™åˆ¶

- **ç½‘ç»œå¼€é”€**ï¼šéœ€è¦ç½‘ç»œä¼ è¾“ï¼Œæœ‰å»¶è¿Ÿ
- **éœ€è¦åç«¯**ï¼šéœ€è¦ç»´æŠ¤ Node.js åç«¯æœåŠ¡

### æ–¹æ¡ˆä¸‰ï¼šç¼–è¯‘ä¸º WASMï¼ˆæ‰€æœ‰å¹³å°ï¼‰

å¦‚æœéœ€è¦ç»Ÿä¸€æ”¯æŒæ‰€æœ‰å¹³å°ï¼ˆNode.jsã€æµè§ˆå™¨ã€React
Nativeï¼‰ï¼Œå¯ä»¥å°† Rust ä»£ç ç¼–è¯‘ä¸º WASMã€‚**WASM æ¨¡å—å¯ä»¥åœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œ**ï¼ˆNode.js
v8.0.0+ åŸç”Ÿæ”¯æŒï¼‰ã€‚

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust æºä»£ç                              â”‚
â”‚ - ä½¿ç”¨æ¡ä»¶ç¼–è¯‘åŒºåˆ† NAPI å’Œ WASM         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAPI ç¼–è¯‘    â”‚    â”‚ WASM ç¼–è¯‘         â”‚
â”‚ (Node.js)    â”‚    â”‚ (Web/ç§»åŠ¨ç«¯)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°æ­¥éª¤

**1. ä¿®æ”¹ Cargo.tomlï¼Œæ·»åŠ  WASM æ”¯æŒ**ï¼š

```toml
[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
# NAPI ä¾èµ–ï¼ˆæ¡ä»¶ç¼–è¯‘ï¼‰
napi = { version = "3.0.0", optional = true }
napi-derive = { version = "3.0.0", optional = true }

# WASM ä¾èµ–ï¼ˆæ¡ä»¶ç¼–è¯‘ï¼‰
wasm-bindgen = { version = "0.2", optional = true }

[features]
default = ["napi"]
napi = ["napi", "napi-derive"]
wasm = ["wasm-bindgen"]
```

**2. ä¿®æ”¹ä»£ç ï¼Œæ”¯æŒæ¡ä»¶ç¼–è¯‘**ï¼š

```rust
// lib.rs
#[cfg(feature = "napi")]
use napi_derive::napi;

#[cfg(feature = "wasm")]
use wasm_bindgen::prelude::*;

#[cfg(feature = "napi")]
#[napi]
pub fn compress_to_webp(image_data: Vec<u8>, options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    // NAPI å®ç°
}

#[cfg(feature = "wasm")]
#[wasm_bindgen]
pub fn compress_to_webp(image_data: &[u8], options: Option<WebPCompressOptions>) -> Result<WebPCompressResult> {
    // WASM å®ç°ï¼ˆç›¸åŒé€»è¾‘ï¼‰
}
```

**3. æ„å»º WASM ç‰ˆæœ¬**ï¼š

```bash
# å®‰è£… wasm-pack
cargo install wasm-pack

# æ„å»º WASM ç‰ˆæœ¬
wasm-pack build --target web --out-dir pkg-web

# æ„å»º React Native ç‰ˆæœ¬
wasm-pack build --target bundler --out-dir pkg-mobile
```

**4. åœ¨ Node.js ä¸­ä½¿ç”¨**ï¼š

```javascript
// Node.js ç¯å¢ƒï¼ˆv8.0.0+ï¼‰
const { readFileSync } = require('fs');
const { WASI } = require('wasi');
const {
  initSync,
  compress_to_webp,
} = require('pixuli-wasm/pkg-node/pixuli_wasm.js');

// åˆå§‹åŒ– WASM æ¨¡å—ï¼ˆåŒæ­¥æ–¹å¼ï¼‰
initSync();

// æˆ–è€…ä½¿ç”¨å¼‚æ­¥æ–¹å¼
// const init = require('pixuli-wasm/pkg-node/pixuli_wasm.js');
// await init();

async function compressImage(imagePath, options) {
  const imageData = readFileSync(imagePath);
  const result = compress_to_webp(imageData, options);
  return result;
}
```

**5. åœ¨ Web ç«¯ä½¿ç”¨**ï¼š

```javascript
import init, { compress_to_webp } from 'pixuli-wasm/pkg-web/pixuli_wasm.js';

async function compressImage(imageData, options) {
  // åˆå§‹åŒ– WASM æ¨¡å—
  await init();

  // è°ƒç”¨ WASM å‡½æ•°
  const result = compress_to_webp(imageData, options);
  return result;
}
```

**6. åœ¨ React Native ä¸­ä½¿ç”¨**ï¼š

```javascript
import { loadWasmModule } from 'react-native-wasm';
import { compress_to_webp } from 'pixuli-wasm/pkg-mobile/pixuli_wasm';

async function compressImage(imageData, options) {
  // åŠ è½½ WASM æ¨¡å—
  await loadWasmModule('pixuli-wasm/pkg-mobile/pixuli_wasm.wasm');

  // è°ƒç”¨ WASM å‡½æ•°
  const result = compress_to_webp(imageData, options);
  return result;
}
```

#### ä¼˜åŠ¿

- **ç»Ÿä¸€æ„å»º**ï¼šä¸€å¥—ä»£ç ï¼Œæ‰€æœ‰å¹³å°é€šç”¨
- **ç›´æ¥è¿è¡Œ**ï¼šå¯ä»¥åœ¨ Node.jsã€æµè§ˆå™¨å’Œ React Native ä¸­ç›´æ¥è¿è¡Œ
- **æ— éœ€æ¡¥æ¥**ï¼šä¸éœ€è¦ Electron æˆ–åç«¯æœåŠ¡ï¼ˆæµè§ˆå™¨å’Œç§»åŠ¨ç«¯ï¼‰
- **ç¦»çº¿æ”¯æŒ**ï¼šå¯ä»¥åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨
- **è·¨å¹³å°å…¼å®¹**ï¼šNode.js v8.0.0+ åŸç”Ÿæ”¯æŒ WASM

#### é™åˆ¶

- **æ€§èƒ½è¾ƒä½**ï¼šWASM æ€§èƒ½ä¸å¦‚ NAPI åŸç”Ÿæ¨¡å—ï¼ˆçº¦ 10-20% æ€§èƒ½å·®å¼‚ï¼‰
- **åˆå§‹åŒ–å¼€é”€**ï¼šé¦–æ¬¡åŠ è½½éœ€è¦åˆå§‹åŒ– WASM æ¨¡å—
- **ä¾èµ–é™åˆ¶**ï¼šæŸäº›ä¾èµ–ï¼ˆå¦‚ ONNX Runtimeï¼‰å¯èƒ½ä¸æ”¯æŒ WASM
- **å†…å­˜é™åˆ¶**ï¼šWASM å†…å­˜ç®¡ç†ç›¸å¯¹å¤æ‚

#### NAPI vs WASM æ€§èƒ½å¯¹æ¯”ï¼ˆNode.js ç¯å¢ƒï¼‰

| æŒ‡æ ‡       | NAPI åŸç”Ÿæ¨¡å—    | WASM æ¨¡å— | è¯´æ˜              |
| ---------- | ---------------- | --------- | ----------------- |
| å¯åŠ¨é€Ÿåº¦   | å¿«               | è¾ƒæ…¢      | WASM éœ€è¦åˆå§‹åŒ–   |
| è¿è¡Œæ€§èƒ½   | 100%             | 80-90%    | WASM æœ‰æ€§èƒ½å¼€é”€   |
| å†…å­˜å ç”¨   | ä½               | ç¨é«˜      | WASM éœ€è¦é¢å¤–å†…å­˜ |
| æ„å»ºå¤æ‚åº¦ | ä¸­ç­‰             | ç®€å•      | WASM æ„å»ºæ›´ç»Ÿä¸€   |
| è·¨å¹³å°æ”¯æŒ | Node.js/Electron | æ‰€æœ‰å¹³å°  | WASM æ”¯æŒæ›´å¹¿     |

### æ–¹æ¡ˆé€‰æ‹©å»ºè®®

| åœºæ™¯                        | æ¨èæ–¹æ¡ˆ              | åŸå›                        |
| --------------------------- | --------------------- | -------------------------- |
| Electron åº”ç”¨ï¼ˆPC ç«¯ï¼‰      | æ–¹æ¡ˆä¸€ï¼šElectron æ¡¥æ¥ | æ€§èƒ½æœ€ä¼˜ï¼Œé›†æˆç®€å•         |
| React Native åº”ç”¨ï¼ˆç§»åŠ¨ç«¯ï¼‰ | æ–¹æ¡ˆäºŒï¼šNode.js åç«¯  | æ€§èƒ½æœ€ä¼˜ï¼Œç»Ÿä¸€ä»£ç          |
| çº¯ Web åº”ç”¨ï¼ˆæµè§ˆå™¨ï¼‰       | æ–¹æ¡ˆä¸‰ï¼šWASM          | å¯ä»¥ç›´æ¥è¿è¡Œ               |
| éœ€è¦ç¦»çº¿æ”¯æŒ                | æ–¹æ¡ˆä¸‰ï¼šWASM          | æ— éœ€ç½‘ç»œè¿æ¥               |
| éœ€è¦æœ€ä½³æ€§èƒ½                | æ–¹æ¡ˆä¸€/äºŒï¼šNAPI       | åŸç”Ÿæ€§èƒ½                   |
| éœ€è¦ç»Ÿä¸€æ„å»ºï¼ˆæ‰€æœ‰å¹³å°ï¼‰    | æ–¹æ¡ˆä¸‰ï¼šWASM          | ä¸€å¥—ä»£ç ï¼Œæ‰€æœ‰å¹³å°         |
| Node.js åç«¯æœåŠ¡            | NAPI æˆ– WASM          | NAPI æ€§èƒ½æ›´å¥½ï¼ŒWASM æ›´ç®€å• |

---

## ğŸ“ æ€»ç»“

WASM æ¨¡å—æ˜¯ Pixuli é¡¹ç›®çš„æ ¸å¿ƒæ€§èƒ½ç»„ä»¶ï¼Œé€šè¿‡ Rust å®ç°æä¾›äº†é«˜æ€§èƒ½çš„å›¾ç‰‡å¤„ç†èƒ½åŠ›ã€‚

### å½“å‰å®ç°

é¡¹ç›®**å½“å‰ä½¿ç”¨ NAPI-RS å®ç°**ï¼Œç¼–è¯‘ä¸º Node.js åŸç”Ÿæ¨¡å—ï¼ˆ`.node`
æ–‡ä»¶ï¼‰ï¼Œå®Œç¾æ”¯æŒ Electron å’Œ Node.js ç¯å¢ƒï¼Œæ€§èƒ½æœ€ä¼˜ã€‚

**å½“å‰å®ç°ç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ `#[napi]` å®æ ‡è®°å‡½æ•°
- é€šè¿‡ `napi build` å‘½ä»¤ç¼–è¯‘
- ç”Ÿæˆ `.node` åŸç”Ÿæ¨¡å—æ–‡ä»¶
- æ”¯æŒ Windowsã€macOSã€Linux å¤šå¹³å°
- æ€§èƒ½æœ€ä¼˜ï¼ˆåŸç”Ÿæ¨¡å—ï¼‰

### æœªæ¥æ–¹å‘

å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒ React Nativeã€Web å’Œ Electronï¼Œæœ‰ä»¥ä¸‹é€‰æ‹©ï¼š

1. **æ··åˆæ–¹æ¡ˆ**ï¼šä¿æŒ NAPI-RS ç”¨äº Electron/Node.jsï¼Œæ·»åŠ  WASM ç”¨äº Web/React
   Native
   - ä¼˜åŠ¿ï¼šElectron ä¿æŒæœ€ä½³æ€§èƒ½ï¼ŒåŒæ—¶æ”¯æŒ Web/React Native
   - æˆæœ¬ï¼šéœ€è¦ç»´æŠ¤ä¸¤å¥—æ„å»ºé…ç½®

2. **ç»Ÿä¸€æ–¹æ¡ˆ**ï¼šè¿ç§»åˆ° WASM ç»Ÿä¸€æ„å»ºï¼Œä¸€å¥—ä»£ç æ”¯æŒæ‰€æœ‰å¹³å°
   - ä¼˜åŠ¿ï¼šç»Ÿä¸€æ„å»ºæµç¨‹ï¼Œç»´æŠ¤æˆæœ¬ä½
   - æˆæœ¬ï¼šæ€§èƒ½ç•¥ä½äº NAPIï¼ˆ80-90%ï¼‰ï¼Œä½†å¯¹äºå›¾ç‰‡å¤„ç†åœºæ™¯è¶³å¤Ÿ

**æ¨è**ï¼š

- **å¦‚æœåªéœ€è¦ Electron**ï¼šç»§ç»­ä½¿ç”¨ NAPI-RSï¼Œæ€§èƒ½æœ€ä¼˜
- **å¦‚æœéœ€è¦å¤šå¹³å°æ”¯æŒ**ï¼šè€ƒè™‘è¿ç§»åˆ° WASM æˆ–ä½¿ç”¨æ··åˆæ–¹æ¡ˆ

### WASM ç»Ÿä¸€æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼ˆå¦‚æœè¿ç§»ï¼‰

1. **ç»Ÿä¸€ä»£ç åº“**ï¼šåªéœ€ç»´æŠ¤ä¸€å¥— Rust ä»£ç ï¼Œæ‰€æœ‰å¹³å°å…±äº«
2. **ç»Ÿä¸€æ„å»ºæµç¨‹**ï¼šä½¿ç”¨ `wasm-pack build` å³å¯ä¸ºæ‰€æœ‰å¹³å°æ„å»º
3. **æ™ºèƒ½åŠ è½½**ï¼šé€šè¿‡ package.json çš„ exports å­—æ®µï¼Œè‡ªåŠ¨æ ¹æ®è¿è¡Œç¯å¢ƒé€‰æ‹©æ­£ç¡®çš„æ¨¡å—
4. **è·¨å¹³å°å…¼å®¹**ï¼šWASM æ˜¯ Web æ ‡å‡†ï¼Œæ‰€æœ‰ç°ä»£ç¯å¢ƒéƒ½åŸç”Ÿæ”¯æŒ
5. **æ€§èƒ½ä¼˜ç§€**ï¼šè™½ç„¶ç•¥ä½äº NAPIï¼ˆ80-90%ï¼‰ï¼Œä½†å¯¹äºå›¾ç‰‡å¤„ç†åœºæ™¯å·²ç»è¶³å¤Ÿ

è®¾è®¡å……åˆ†è€ƒè™‘äº†è·¨å¹³å°å…¼å®¹æ€§ã€å†…å­˜å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–ã€‚å½“å‰é€šè¿‡ NAPI-RS å®ç°äº†ä¸ Node.js/Electron ç¯å¢ƒçš„æ— ç¼é›†æˆï¼Œå¦‚æœæœªæ¥éœ€è¦æ”¯æŒæ›´å¤šå¹³å°ï¼Œå¯ä»¥è€ƒè™‘è¿ç§»åˆ° WASM ç»Ÿä¸€æ–¹æ¡ˆã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è·¨ç«¯èµ„æºå…±äº«è®¾è®¡æ–¹æ¡ˆ](./01-cross-platform-resources.md) - äº†è§£è·¨ç«¯èµ„æºå…±äº«
- [æ€§èƒ½ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ](./03-performance) - äº†è§£æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

---

æœ€åæ›´æ–°ï¼š2025å¹´11æœˆ
