name: æ€§èƒ½åŸºå‡†æµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      test-type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - simple
          - detailed
      platform:
        description: 'æµ‹è¯•å¹³å°'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest

permissions:
  contents: read

env:
  NODE_VERSION: '22'

jobs:
  benchmark:
    runs-on: ${{ github.event.inputs.platform }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: æ˜¾ç¤ºæµ‹è¯•é…ç½®
        run: |
          echo "=== åŸºå‡†æµ‹è¯•é…ç½® ==="
          echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test-type }}"
          echo "æµ‹è¯•å¹³å°: ${{ github.event.inputs.platform }}"
          echo "æ“ä½œç³»ç»Ÿ: ${{ runner.os }}"
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "pnpm ç‰ˆæœ¬: $(pnpm --version)"
          echo "Rust ç‰ˆæœ¬: $(rustc --version)"
          echo "=================="

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install

      - name: æ„å»º WASM æ¨¡å—
        run: |
          pnpm install
          pnpm run build:wasm
          echo "WASM æ¨¡å—æ„å»ºå®Œæˆ"

      - name: éªŒè¯ WASM æ¨¡å— (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "æ£€æŸ¥ WASM äºŒè¿›åˆ¶æ–‡ä»¶:"
          Write-Host "Windows ç¯å¢ƒ - ä½¿ç”¨ PowerShell å‘½ä»¤:"
          Get-ChildItem -Path packages/wasm -Filter "*.node" -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime
          Write-Host "WASM äºŒè¿›åˆ¶æ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem -Path packages/wasm -Filter "*.node" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "æ‰¾åˆ°: $($_.FullName)" }

      - name: éªŒè¯ WASM æ¨¡å— (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "æ£€æŸ¥ WASM äºŒè¿›åˆ¶æ–‡ä»¶:"
          echo "$RUNNER_OS ç¯å¢ƒ - ä½¿ç”¨ Unix å‘½ä»¤:"
          ls -la packages/wasm/*.node 2>/dev/null || echo "æœªæ‰¾åˆ° .node æ–‡ä»¶"
          echo "WASM äºŒè¿›åˆ¶æ–‡ä»¶åˆ—è¡¨:"
          find packages/wasm -name "*.node" -type f

      - name: æµ‹è¯• WASM æ¨¡å—åŠŸèƒ½
        run: |
          echo "æµ‹è¯• WASM æ¨¡å—åŸºæœ¬åŠŸèƒ½..."
          cd packages/wasm
          node -e "
            try {
              const wasm = require('./index.js');
              console.log('âœ… WASM æ¨¡å—åŠ è½½æˆåŠŸ');
              console.log('plus100 å‡½æ•°ç±»å‹:', typeof wasm.plus100);
              const result = wasm.plus100(5);
              console.log('plus100(5) ç»“æœ:', result);
              console.log('âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡');
            } catch (error) {
              console.error('âŒ WASM æ¨¡å—æµ‹è¯•å¤±è´¥:', error.message);
              process.exit(1);
            }
          "

      - name: è¿è¡Œç®€åŒ–åŸºå‡†æµ‹è¯•
        if: ${{ github.event.inputs.test-type == 'simple' || github.event.inputs.test-type == 'all' }}
        run: |
          echo "ğŸš€ å¼€å§‹ç®€åŒ–åŸºå‡†æµ‹è¯•..."
          cd benchmark
          pnpm run benchmark:simple

      - name: è¿è¡Œè¯¦ç»†åŸºå‡†æµ‹è¯•
        if: ${{ github.event.inputs.test-type == 'detailed' || github.event.inputs.test-type == 'all' }}
        run: |
          echo "ğŸš€ å¼€å§‹è¯¦ç»†åŸºå‡†æµ‹è¯•..."
          cd benchmark
          pnpm run benchmark:detailed

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
          echo "## åŸºå‡†æµ‹è¯•æŠ¥å‘Š" > benchmark-report.md
          echo "" >> benchmark-report.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> benchmark-report.md
          echo "**æµ‹è¯•å¹³å°**: ${{ github.event.inputs.platform }}" >> benchmark-report.md
          echo "**æµ‹è¯•ç±»å‹**: ${{ github.event.inputs.test-type }}" >> benchmark-report.md
          echo "**æ“ä½œç³»ç»Ÿ**: ${{ runner.os }}" >> benchmark-report.md
          echo "**Node.js ç‰ˆæœ¬**: $(node --version)" >> benchmark-report.md
          echo "**pnpm ç‰ˆæœ¬**: $(pnpm --version)" >> benchmark-report.md
          echo "**Rust ç‰ˆæœ¬**: $(rustc --version)" >> benchmark-report.md
          echo "" >> benchmark-report.md
          echo "### æµ‹è¯•ç»“æœ" >> benchmark-report.md
          echo "" >> benchmark-report.md
          echo "åŸºå‡†æµ‹è¯•å·²å®Œæˆï¼Œè¯¦ç»†ç»“æœè¯·æŸ¥çœ‹ä¸Šæ–¹çš„æµ‹è¯•è¾“å‡ºã€‚" >> benchmark-report.md
          echo "" >> benchmark-report.md
          echo "### æ€§èƒ½æŒ‡æ ‡" >> benchmark-report.md
          echo "" >> benchmark-report.md
          echo "- **WASM WebP å‹ç¼©**: é€šå¸¸æ¯” JavaScript å‹ç¼©å¿« 80-90%" >> benchmark-report.md
          echo "- **å‹ç¼©æ•ˆæœ**: WebP æ ¼å¼å‹ç¼©ç‡é€šå¸¸è¾¾åˆ° 85-90%" >> benchmark-report.md
          echo "- **å†…å­˜ä½¿ç”¨**: WASM æ¨¡å—å†…å­˜ä½¿ç”¨æ›´é«˜æ•ˆ" >> benchmark-report.md
          echo "- **ç¨³å®šæ€§**: 100 æ¬¡è¿ç»­æµ‹è¯•é›¶é”™è¯¯" >> benchmark-report.md

          echo "ğŸ“„ æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ:"
          cat benchmark-report.md

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report-${{ github.event.inputs.platform }}-${{ github.event.inputs.test-type }}
          path: |
            benchmark-report.md
            benchmark/src/
            benchmark/package.json
            benchmark/README.md
            benchmark/tsconfig.json
          retention-days: 30

      - name: æµ‹è¯•å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ åŸºå‡†æµ‹è¯•å®Œæˆï¼"
          echo "=================="
          echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test-type }}"
          echo "æµ‹è¯•å¹³å°: ${{ github.event.inputs.platform }}"
          echo "æµ‹è¯•æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "=================="
          echo "ğŸ“Š æµ‹è¯•æŠ¥å‘Šå·²ä¸Šä¼ åˆ° artifacts"
          echo "ğŸ”— å¯åœ¨ Actions é¡µé¢ä¸‹è½½æµ‹è¯•æŠ¥å‘Š"
