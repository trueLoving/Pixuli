name: 发布 Pixuli Mobile

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '选择要发布的平台'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
        default: both
      releaseToGitHub:
        description: '将产物附加到 GitHub Release（仅在 tag 或手动开启时）'
        required: true
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  PNPM_VERSION: 9
  NODE_VERSION: 20

jobs:
  detect:
    name: Detect inputs
    runs-on: ubuntu-latest
    outputs:
      do_android: ${{ steps.set.outputs.do_android }}
      do_ios: ${{ steps.set.outputs.do_ios }}
      is_tag: ${{ steps.set.outputs.is_tag }}
      release_enabled: ${{ steps.set.outputs.release_enabled }}
    steps:
      - name: Resolve inputs
        id: set
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PLATFORM="${{ github.event.inputs.platform }}"
            RELEASE_INPUT="${{ github.event.inputs.releaseToGitHub }}"
          else
            # tag push 默认 both，发布 release
            PLATFORM="both"
            RELEASE_INPUT="true"
          fi

          DO_ANDROID=false
          DO_IOS=false
          if [[ "$PLATFORM" == "android" || "$PLATFORM" == "both" ]]; then DO_ANDROID=true; fi
          if [[ "$PLATFORM" == "ios" || "$PLATFORM" == "both" ]]; then DO_IOS=true; fi

          IS_TAG=false
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then IS_TAG=true; fi

          echo "do_android=$DO_ANDROID" >> $GITHUB_OUTPUT
          echo "do_ios=$DO_IOS" >> $GITHUB_OUTPUT
          echo "is_tag=$IS_TAG" >> $GITHUB_OUTPUT
          echo "release_enabled=$RELEASE_INPUT" >> $GITHUB_OUTPUT

  android:
    name: Android build
    needs: detect
    if: needs.detect.outputs.do_android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Generate Android native project
        run: npx expo prebuild --platform android --clean
        working-directory: apps/mobile

      - name: Cache Gradle build cache
        uses: actions/cache@v4
        with:
          path: apps/mobile/android/.gradle
          key: ${{ runner.os }}-gradle-build-${{ hashFiles('apps/mobile/android/**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
        working-directory: apps/mobile

      - name: Build Android (APK)
        id: build
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon
          echo "构建完成，退出码: $?"
        working-directory: apps/mobile

      - name: Extract version
        id: version
        shell: bash
        run: |
          # 从 package.json 获取版本号，或从 tag 中提取
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            # 从 tag 中提取版本号（去掉 v 前缀）
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          else
            # 从 package.json 获取版本号
            VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "版本号: $VERSION"
        working-directory: apps/mobile

      - name: Locate artifacts
        id: afp
        shell: bash
        run: |
          echo "=== 查找 APK 文件 ==="
          echo "当前工作目录: $(pwd)"

          # 检查 android 目录是否存在
          if [ ! -d "android" ]; then
            echo "错误: android 目录不存在"
            echo "当前目录内容:"
            ls -la
            exit 1
          fi

          # 使用相对于 apps/mobile 的路径
          APK_DIR="android/app/build/outputs/apk/release"
          echo "查找目录: $APK_DIR"

          # 检查构建输出目录结构
          echo "=== 检查构建输出目录结构 ==="
          if [ -d "android/app/build" ]; then
            echo "android/app/build 目录存在"
            find android/app/build -type d -name "outputs" 2>/dev/null | head -5 || echo "未找到 outputs 目录"
          else
            echo "android/app/build 目录不存在"
          fi

          if [ -d "android/app/build/outputs" ]; then
            echo "android/app/build/outputs 目录存在"
            ls -la android/app/build/outputs/ || echo "无法列出 outputs 目录"
          fi

          if [ ! -d "$APK_DIR" ]; then
            echo "错误: APK 目录不存在: $APK_DIR"
            echo "搜索所有可能的 APK 位置:"
            find android -name "*.apk" -type f 2>/dev/null || echo "未找到任何 APK 文件"
            echo "搜索所有 build 目录:"
            find android -type d -name "build" 2>/dev/null | head -10
            exit 1
          fi

          echo "APK 目录内容:"
          ls -la "$APK_DIR" || echo "目录为空"

          # 查找 APK 文件（相对于当前目录 apps/mobile）
          APK_FILE=$(find "$APK_DIR" -name "*.apk" -type f | head -n1)

          if [ -z "$APK_FILE" ]; then
            echo "错误: 未找到 APK 文件"
            echo "搜索所有可能的 APK 位置:"
            find android -name "*.apk" -type f 2>/dev/null || echo "未找到任何 APK 文件"
            exit 1
          fi

          echo "找到 APK 文件: $APK_FILE"
          echo "文件大小: $(du -h "$APK_FILE" | cut -f1)"

          # 确保路径是相对于 apps/mobile 的（去掉开头的 ./ 如果有）
          APK_FILE="${APK_FILE#./}"

          # 转换为相对于项目根目录的路径
          # 当前在 apps/mobile，APK_FILE 应该是 android/app/build/... 格式
          # 所以完整路径是 apps/mobile/android/app/build/...
          APK_RELATIVE_PATH="apps/mobile/$APK_FILE"

          echo "相对路径: $APK_RELATIVE_PATH"
          echo "验证路径是否存在:"
          if [ -f "$APK_RELATIVE_PATH" ]; then
            echo "✓ 文件存在: $APK_RELATIVE_PATH"
          else
            echo "✗ 文件不存在: $APK_RELATIVE_PATH"
            echo "尝试使用绝对路径:"
            ABSOLUTE_PATH="$(pwd)/$APK_FILE"
            echo "绝对路径: $ABSOLUTE_PATH"
            if [ -f "$ABSOLUTE_PATH" ]; then
              echo "✓ 绝对路径文件存在"
              # 从绝对路径提取相对路径
              PROJECT_ROOT="${GITHUB_WORKSPACE:-/home/runner/work/Pixuli/Pixuli}"
              APK_RELATIVE_PATH="${ABSOLUTE_PATH#$PROJECT_ROOT/}"
              echo "计算后的相对路径: $APK_RELATIVE_PATH"
            fi
          fi

          echo "apk=$APK_RELATIVE_PATH" >> $GITHUB_OUTPUT
        working-directory: apps/mobile

      - name: Rename APK for release
        id: rename_apk
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APK_SOURCE="${{ steps.afp.outputs.apk }}"

          # 获取文件扩展名
          EXT="${APK_SOURCE##*.}"

          # 生成新文件名：Pixuli_版本号.后缀名
          APK_NEW_NAME="Pixuli_${VERSION}.${EXT}"

          # 获取源文件的目录
          APK_DIR=$(dirname "$APK_SOURCE")

          # 新文件的完整路径
          APK_NEW_PATH="${APK_DIR}/${APK_NEW_NAME}"

          # 复制并重命名文件
          cp "$APK_SOURCE" "$APK_NEW_PATH"

          echo "原文件: $APK_SOURCE"
          echo "新文件: $APK_NEW_PATH"
          echo "新文件名: $APK_NEW_NAME"

          echo "apk_release=$APK_NEW_PATH" >> $GITHUB_OUTPUT
          echo "apk_release_name=$APK_NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.afp.outputs.apk }}
          if-no-files-found: error

      - name: Attach to GitHub Release
        if: needs.detect.outputs.release_enabled == 'true' && (needs.detect.outputs.is_tag == 'true' || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.rename_apk.outputs.apk_release }}
          file_glob: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios:
    name: iOS build (EAS)
    needs: detect
    if: needs.detect.outputs.do_ios == 'true'
    runs-on: macos-14
    defaults:
      run:
        working-directory: apps/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Install EAS CLI
        run: pnpm dlx eas-cli@latest --version

      - name: EAS build (iOS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          pnpm dlx eas-cli build --platform ios --non-interactive --no-wait
          # 由于 EAS 云端构建，此处仅输出提交信息与链接

      - name: Extract version
        id: version
        shell: bash
        run: |
          # 从 package.json 获取版本号，或从 tag 中提取
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            # 从 tag 中提取版本号（去掉 v 前缀）
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          else
            # 从 package.json 获取版本号
            VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "版本号: $VERSION"
        working-directory: apps/mobile

      - name: Upload EAS build info
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          INFO_FILE="Pixuli_${VERSION}.txt"
          echo "EAS iOS 构建已触发，登录 Expo 查看进度与产物下载。" > "$INFO_FILE"
          echo "info_file=$INFO_FILE" >> $GITHUB_OUTPUT
          echo "info_file_path=apps/mobile/$INFO_FILE" >> $GITHUB_OUTPUT

      - name: Upload iOS build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-eas-info
          path: apps/mobile/Pixuli_${{ steps.version.outputs.VERSION }}.txt

      - name: Attach info to GitHub Release
        if: needs.detect.outputs.release_enabled == 'true' && (needs.detect.outputs.is_tag == 'true' || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            apps/mobile/Pixuli_${{ steps.version.outputs.VERSION }}.txt
          file_glob: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
