name: 发布 Pixuli Mobile

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '选择要发布的平台'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
        default: both
      releaseToGitHub:
        description: '将产物附加到 GitHub Release（仅在 tag 或手动开启时）'
        required: true
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  PNPM_VERSION: 10
  NODE_VERSION: 22

jobs:
  detect:
    name: Detect inputs
    runs-on: ubuntu-latest
    outputs:
      do_android: ${{ steps.set.outputs.do_android }}
      do_ios: ${{ steps.set.outputs.do_ios }}
      is_tag: ${{ steps.set.outputs.is_tag }}
      release_enabled: ${{ steps.set.outputs.release_enabled }}
      version: ${{ steps.set.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve inputs
        id: set
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PLATFORM="${{ github.event.inputs.platform }}"
            RELEASE_INPUT="${{ github.event.inputs.releaseToGitHub }}"
          else
            # tag push 默认 both，发布 release
            PLATFORM="both"
            RELEASE_INPUT="true"
          fi

          DO_ANDROID=false
          DO_IOS=false
          if [[ "$PLATFORM" == "android" || "$PLATFORM" == "both" ]]; then DO_ANDROID=true; fi
          if [[ "$PLATFORM" == "ios" || "$PLATFORM" == "both" ]]; then DO_IOS=true; fi

          IS_TAG=false
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then IS_TAG=true; fi

          # 提取版本号：从 tag 或 app.json
          if [[ "$IS_TAG" == "true" ]]; then
            # 从 tag 提取版本号（去掉 v 前缀）
            VERSION="${GITHUB_REF#refs/tags/v}"
            VERSION="${VERSION#refs/tags/}"
          else
            # 从 app.json 读取版本号
            VERSION=$(grep -o '"version": "[^"]*"' apps/mobile/app.json | cut -d'"' -f4)
          fi

          # 如果版本号为空，使用默认值
          if [[ -z "$VERSION" ]]; then
            VERSION="1.0.0"
          fi

          echo "do_android=$DO_ANDROID" >> $GITHUB_OUTPUT
          echo "do_ios=$DO_IOS" >> $GITHUB_OUTPUT
          echo "is_tag=$IS_TAG" >> $GITHUB_OUTPUT
          echo "release_enabled=$RELEASE_INPUT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "检测到的版本号: $VERSION"

  android:
    name: Android build
    needs: detect
    if: needs.detect.outputs.do_android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Generate Android native project
        run: npx expo prebuild --platform android --clean
        working-directory: apps/mobile

      - name: Extract version
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "版本号: $VERSION"

      - name: Configure APK output filename
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILD_GRADLE="android/app/build.gradle"

          # 检查 build.gradle 是否已包含 applicationVariants 配置
          if grep -q "applicationVariants.all" "$BUILD_GRADLE"; then
            echo "build.gradle 已包含 applicationVariants 配置，更新版本号"
            # 更新现有配置中的版本号
            sed -i "s/def apkName = \"Pixuli_[^\"]*\"/def apkName = \"Pixuli_${VERSION}\"/" "$BUILD_GRADLE"
          else
            echo "添加 applicationVariants 配置到 build.gradle"
            # 使用 printf 构建配置内容，避免 heredoc 的 YAML 缩进问题
            printf '\n// 配置 APK 输出文件名\n' >> "$BUILD_GRADLE"
            printf 'android.applicationVariants.all { variant ->\n' >> "$BUILD_GRADLE"
            printf '    variant.outputs.all { output ->\n' >> "$BUILD_GRADLE"
            printf '        def apkName = "Pixuli_%s.apk"\n' "$VERSION" >> "$BUILD_GRADLE"
            printf '        outputFileName = apkName\n' >> "$BUILD_GRADLE"
            printf '    }\n' >> "$BUILD_GRADLE"
            printf '}\n' >> "$BUILD_GRADLE"
          fi

          echo "APK 输出文件名已配置为: Pixuli_${VERSION}.apk"
        working-directory: apps/mobile

      - name: Cache Gradle build cache
        uses: actions/cache@v4
        with:
          path: apps/mobile/android/.gradle
          key: ${{ runner.os }}-gradle-build-${{ hashFiles('apps/mobile/android/**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-build-

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
        working-directory: apps/mobile

      - name: Build Android (APK)
        id: build
        run: |
          cd android
          # 启用 daemon、并行构建和构建缓存以优化构建速度
          ./gradlew assembleRelease --parallel --build-cache --daemon
          echo "构建完成，退出码: $?"
        working-directory: apps/mobile

      - name: Locate artifacts
        id: afp
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          EXPECTED_APK_NAME="Pixuli_${VERSION}.apk"

          echo "=== 查找 APK 文件 ==="
          echo "当前工作目录: $(pwd)"
          echo "期望的 APK 文件名: $EXPECTED_APK_NAME"

          # 检查 android 目录是否存在
          if [ ! -d "android" ]; then
            echo "错误: android 目录不存在"
            echo "当前目录内容:"
            ls -la
            exit 1
          fi

          # 使用相对于 apps/mobile 的路径
          APK_DIR="android/app/build/outputs/apk/release"
          echo "查找目录: $APK_DIR"

          if [ ! -d "$APK_DIR" ]; then
            echo "错误: APK 目录不存在: $APK_DIR"
            echo "搜索所有可能的 APK 位置:"
            find android -name "*.apk" -type f 2>/dev/null || echo "未找到任何 APK 文件"
            exit 1
          fi

          echo "APK 目录内容:"
          ls -la "$APK_DIR" || echo "目录为空"

          # 优先查找期望的文件名，如果不存在则查找任何 APK 文件
          APK_FILE=""
          if [ -f "$APK_DIR/$EXPECTED_APK_NAME" ]; then
            APK_FILE="$APK_DIR/$EXPECTED_APK_NAME"
            echo "✓ 找到期望的 APK 文件: $EXPECTED_APK_NAME"
          else
            echo "未找到期望的文件名，搜索所有 APK 文件:"
            APK_FILE=$(find "$APK_DIR" -name "*.apk" -type f | head -n1)
            if [ -n "$APK_FILE" ]; then
              echo "找到 APK 文件: $APK_FILE"
              echo "警告: 文件名不符合预期格式，期望: $EXPECTED_APK_NAME"
            fi
          fi

          if [ -z "$APK_FILE" ]; then
            echo "错误: 未找到 APK 文件"
            echo "搜索所有可能的 APK 位置:"
            find android -name "*.apk" -type f 2>/dev/null || echo "未找到任何 APK 文件"
            exit 1
          fi

          echo "找到 APK 文件: $APK_FILE"
          echo "文件大小: $(du -h "$APK_FILE" | cut -f1)"

          # 确保路径是相对于 apps/mobile 的（去掉开头的 ./ 如果有）
          APK_FILE="${APK_FILE#./}"

          # 转换为相对于项目根目录的路径
          APK_RELATIVE_PATH="apps/mobile/$APK_FILE"

          echo "相对路径: $APK_RELATIVE_PATH"
          echo "验证路径是否存在:"
          if [ -f "$APK_RELATIVE_PATH" ]; then
            echo "✓ 文件存在: $APK_RELATIVE_PATH"
          else
            echo "✗ 文件不存在: $APK_RELATIVE_PATH"
            echo "尝试使用绝对路径:"
            ABSOLUTE_PATH="$(pwd)/$APK_FILE"
            echo "绝对路径: $ABSOLUTE_PATH"
            if [ -f "$ABSOLUTE_PATH" ]; then
              echo "✓ 绝对路径文件存在"
              PROJECT_ROOT="${GITHUB_WORKSPACE:-/home/runner/work/Pixuli/Pixuli}"
              APK_RELATIVE_PATH="${ABSOLUTE_PATH#$PROJECT_ROOT/}"
              echo "计算后的相对路径: $APK_RELATIVE_PATH"
            fi
          fi

          echo "apk=$APK_RELATIVE_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$EXPECTED_APK_NAME" >> $GITHUB_OUTPUT
        working-directory: apps/mobile

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.afp.outputs.apk }}
          if-no-files-found: error

      - name: Attach to GitHub Release
        if: needs.detect.outputs.release_enabled == 'true' && (needs.detect.outputs.is_tag == 'true' || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.afp.outputs.apk }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios:
    name: iOS build (EAS)
    needs: detect
    if: needs.detect.outputs.do_ios == 'true'
    runs-on: macos-14
    defaults:
      run:
        working-directory: apps/mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Install EAS CLI
        run: pnpm dlx eas-cli@latest --version

      - name: EAS build (iOS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          pnpm dlx eas-cli build --platform ios --non-interactive --no-wait
          # 由于 EAS 云端构建，此处仅输出提交信息与链接

      - name: Upload EAS build info
        if: always()
        run: |
          echo "EAS iOS 构建已触发，登录 Expo 查看进度与产物下载。" > eas-ios-info.txt

      - name: Upload iOS build info artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-eas-info
          path: eas-ios-info.txt

      - name: Attach info to GitHub Release
        if: needs.detect.outputs.release_enabled == 'true' && (needs.detect.outputs.is_tag == 'true' || github.event_name == 'workflow_dispatch')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            eas-ios-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
