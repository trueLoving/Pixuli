name: å‘å¸ƒ Pixuli Desktop

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      platform:
        description: 'é€‰æ‹©è¦å‘å¸ƒçš„å¹³å°'
        required: true
        type: choice
        options:
          - win
          - mac-x64
          - mac-arm64
          - linux
          - all
        default: all
      is-publish:
        description: 'æ˜¯å¦è¿›è¡Œå‘å¸ƒæ“ä½œ'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '22'

jobs:
  detect:
    name: æ£€æµ‹è¾“å…¥å‚æ•°
    runs-on: ubuntu-latest
    outputs:
      do_win: ${{ steps.set.outputs.do_win }}
      do_mac_x64: ${{ steps.set.outputs.do_mac_x64 }}
      do_mac_arm64: ${{ steps.set.outputs.do_mac_arm64 }}
      do_linux: ${{ steps.set.outputs.do_linux }}
      target_branch: ${{ steps.set.outputs.target_branch }}
      version: ${{ steps.set.outputs.version }}
      is_publish: ${{ steps.set.outputs.is_publish }}
    steps:
      - name: è§£æè¾“å…¥å‚æ•°
        id: set
        shell: bash
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          BRANCH="${{ github.ref_name }}"
          VERSION="${{ github.event.inputs.version }}"
          IS_PUBLISH="${{ github.event.inputs.is-publish }}"

          DO_WIN=false
          DO_MAC_X64=false
          DO_MAC_ARM64=false
          DO_LINUX=false

          if [[ "$PLATFORM" == "win" || "$PLATFORM" == "all" ]]; then DO_WIN=true; fi
          if [[ "$PLATFORM" == "mac-x64" || "$PLATFORM" == "all" ]]; then DO_MAC_X64=true; fi
          if [[ "$PLATFORM" == "mac-arm64" || "$PLATFORM" == "all" ]]; then DO_MAC_ARM64=true; fi
          if [[ "$PLATFORM" == "linux" || "$PLATFORM" == "all" ]]; then DO_LINUX=true; fi

          echo "do_win=$DO_WIN" >> $GITHUB_OUTPUT
          echo "do_mac_x64=$DO_MAC_X64" >> $GITHUB_OUTPUT
          echo "do_mac_arm64=$DO_MAC_ARM64" >> $GITHUB_OUTPUT
          echo "do_linux=$DO_LINUX" >> $GITHUB_OUTPUT
          echo "target_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_publish=$IS_PUBLISH" >> $GITHUB_OUTPUT

          echo "=== æ£€æµ‹ç»“æœ ==="
          echo "å¹³å°é€‰æ‹©: $PLATFORM"
          echo "ç›®æ ‡åˆ†æ”¯: $BRANCH"
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ˜¯å¦å‘å¸ƒ: $IS_PUBLISH"
          echo "æ„å»º Windows: $DO_WIN"
          echo "æ„å»º macOS x64: $DO_MAC_X64"
          echo "æ„å»º macOS ARM64: $DO_MAC_ARM64"
          echo "æ„å»º Linux: $DO_LINUX"
          echo "================"

  build-win:
    name: æ„å»º Windows
    needs: detect
    if: needs.detect.outputs.do_win == 'true'
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: è®¾ç½® Rust/Cargo ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: è®¾ç½® Cargo target ç›®å½•ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            packages/wasm/target/
          key: ${{ runner.os }}-wasm-target-${{ hashFiles('packages/wasm/Cargo.lock', 'packages/wasm/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-wasm-target-

      - name: æ˜¾ç¤ºå‘å¸ƒé…ç½®
        shell: bash
        run: |
          echo "=== å‘å¸ƒé…ç½®ä¿¡æ¯ ==="
          echo "ç‰ˆæœ¬å·: ${{ needs.detect.outputs.version }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ needs.detect.outputs.target_branch }}"
          echo "å¹³å°: Windows x64"
          echo "=================="

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: ä½¿ç”¨ pnpm version æ›´æ–°ç‰ˆæœ¬å·
        shell: bash
        run: |
          cd apps/desktop
          CURRENT_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"

          echo "å½“å‰ç‰ˆæœ¬å·: $CURRENT_VERSION"
          echo "ç›®æ ‡ç‰ˆæœ¬å·: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬å·ä¸º: $TARGET_VERSION"
            pnpm version $TARGET_VERSION --no-git-tag-version
          else
            echo "ç‰ˆæœ¬å·ç›¸åŒï¼Œè·³è¿‡æ›´æ–°ï¼ˆæ”¯æŒé‡å¤å‘å¸ƒï¼‰"
          fi

          echo "å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·:"
          grep '"version"' package.json

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: æ„å»º WASM æ¨¡å—
        shell: bash
        run: |
          echo "æ„å»º Windows x64 WASM æ¨¡å—"
          cd packages/wasm
          # å°è¯•ä½¿ç”¨ sccacheï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªåŠ¨é™çº§åˆ°æ ‡å‡†æ„å»º
          export RUSTC_WRAPPER=sccache
          npx napi build --target x86_64-pc-windows-msvc --platform --release || {
            echo "âš ï¸ sccache æ„å»ºå¤±è´¥ï¼Œé™çº§åˆ°æ ‡å‡†æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰"
            unset RUSTC_WRAPPER
            npx napi build --target x86_64-pc-windows-msvc --platform --release
          }
          echo "WASM æ¨¡å—æ„å»ºå®Œæˆ"
        env:
          SCCACHE_GHA_ENABLED: 'true'
          RUST_BACKTRACE: '1'
          SCCACHE_NO_DAEMON: '1'

      - name: éªŒè¯ WASM æ¨¡å—
        shell: bash
        run: |
          echo "=== éªŒè¯ WASM æ¨¡å—æ„å»ºç»“æœ ==="
          expected_file="pixuli-wasm.win32-x64-msvc.node"
          echo "æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"

          if [ -f "packages/wasm/$expected_file" ]; then
            echo "âœ… æ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la "packages/wasm/$expected_file"
          else
            echo "âŒ æœªæ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la packages/wasm/*.node 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .node æ–‡ä»¶"
            exit 1
          fi
          echo "=== WASM æ¨¡å—éªŒè¯å®Œæˆ ==="

      - name: æ„å»ºå‰ç«¯èµ„æº
        shell: bash
        run: |
          echo "æ„å»ºå‰ç«¯èµ„æº (TypeScript & Vite)"
          cd apps/desktop
          pnpm run build:web

      - name: æ„å»ºæ¡Œé¢åº”ç”¨
        shell: bash
        run: |
          echo "æ„å»º Windows x64 æ¡Œé¢åº”ç”¨"
          cd apps/desktop
          npx electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pixuli-desktop-win-v${{ steps.version.outputs.VERSION }}
          path: |
            apps/desktop/release/*.exe
            !apps/desktop/release/*.blockmap
            !apps/desktop/release/*.yml
            !apps/desktop/release/*.map
          retention-days: 30

  build-mac-x64:
    name: æ„å»º macOS x64
    needs: detect
    if: needs.detect.outputs.do_mac_x64 == 'true'
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: è®¾ç½® Rust/Cargo ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: è®¾ç½® Cargo target ç›®å½•ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            packages/wasm/target/
          key: ${{ runner.os }}-wasm-target-${{ hashFiles('packages/wasm/Cargo.lock', 'packages/wasm/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-wasm-target-

      - name: æ˜¾ç¤ºå‘å¸ƒé…ç½®
        shell: bash
        run: |
          echo "=== å‘å¸ƒé…ç½®ä¿¡æ¯ ==="
          echo "ç‰ˆæœ¬å·: ${{ needs.detect.outputs.version }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ needs.detect.outputs.target_branch }}"
          echo "å¹³å°: macOS x64"
          echo "=================="

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: ä½¿ç”¨ pnpm version æ›´æ–°ç‰ˆæœ¬å·
        shell: bash
        run: |
          cd apps/desktop
          CURRENT_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"

          echo "å½“å‰ç‰ˆæœ¬å·: $CURRENT_VERSION"
          echo "ç›®æ ‡ç‰ˆæœ¬å·: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬å·ä¸º: $TARGET_VERSION"
            pnpm version $TARGET_VERSION --no-git-tag-version
          else
            echo "ç‰ˆæœ¬å·ç›¸åŒï¼Œè·³è¿‡æ›´æ–°ï¼ˆæ”¯æŒé‡å¤å‘å¸ƒï¼‰"
          fi

          echo "å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·:"
          grep '"version"' package.json

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: æ„å»º WASM æ¨¡å—
        shell: bash
        run: |
          echo "æ„å»º macOS x64 WASM æ¨¡å—"
          cd packages/wasm
          # å°è¯•ä½¿ç”¨ sccacheï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªåŠ¨é™çº§åˆ°æ ‡å‡†æ„å»º
          export RUSTC_WRAPPER=sccache
          npx napi build --target x86_64-apple-darwin --platform --release || {
            echo "âš ï¸ sccache æ„å»ºå¤±è´¥ï¼Œé™çº§åˆ°æ ‡å‡†æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰"
            unset RUSTC_WRAPPER
            npx napi build --target x86_64-apple-darwin --platform --release
          }
          echo "WASM æ¨¡å—æ„å»ºå®Œæˆ"
        env:
          SCCACHE_GHA_ENABLED: 'true'
          RUST_BACKTRACE: '1'
          SCCACHE_NO_DAEMON: '1'

      - name: éªŒè¯ WASM æ¨¡å—
        shell: bash
        run: |
          echo "=== éªŒè¯ WASM æ¨¡å—æ„å»ºç»“æœ ==="
          expected_file="pixuli-wasm.darwin-x64.node"
          echo "æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"

          if [ -f "packages/wasm/$expected_file" ]; then
            echo "âœ… æ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la "packages/wasm/$expected_file"
          else
            echo "âŒ æœªæ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la packages/wasm/*.node 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .node æ–‡ä»¶"
            exit 1
          fi
          echo "=== WASM æ¨¡å—éªŒè¯å®Œæˆ ==="

      - name: æ„å»ºå‰ç«¯èµ„æº
        shell: bash
        run: |
          echo "æ„å»ºå‰ç«¯èµ„æº (TypeScript & Vite)"
          cd apps/desktop
          pnpm run build:web

      - name: æ„å»ºæ¡Œé¢åº”ç”¨
        shell: bash
        run: |
          echo "æ„å»º macOS x64 æ¡Œé¢åº”ç”¨"
          cd apps/desktop
          npx electron-builder --mac --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pixuli-desktop-mac-x64-v${{ steps.version.outputs.VERSION }}
          path: |
            apps/desktop/release/*.dmg
            !apps/desktop/release/*.blockmap
            !apps/desktop/release/*.yml
            !apps/desktop/release/*.map
          retention-days: 30

  build-mac-arm64:
    name: æ„å»º macOS ARM64
    needs: detect
    if: needs.detect.outputs.do_mac_arm64 == 'true'
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: è®¾ç½® Rust/Cargo ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: è®¾ç½® Cargo target ç›®å½•ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            packages/wasm/target/
          key: ${{ runner.os }}-wasm-target-${{ hashFiles('packages/wasm/Cargo.lock', 'packages/wasm/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-wasm-target-

      - name: æ˜¾ç¤ºå‘å¸ƒé…ç½®
        shell: bash
        run: |
          echo "=== å‘å¸ƒé…ç½®ä¿¡æ¯ ==="
          echo "ç‰ˆæœ¬å·: ${{ needs.detect.outputs.version }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ needs.detect.outputs.target_branch }}"
          echo "å¹³å°: macOS ARM64"
          echo "=================="

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: ä½¿ç”¨ pnpm version æ›´æ–°ç‰ˆæœ¬å·
        shell: bash
        run: |
          cd apps/desktop
          CURRENT_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"

          echo "å½“å‰ç‰ˆæœ¬å·: $CURRENT_VERSION"
          echo "ç›®æ ‡ç‰ˆæœ¬å·: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬å·ä¸º: $TARGET_VERSION"
            pnpm version $TARGET_VERSION --no-git-tag-version
          else
            echo "ç‰ˆæœ¬å·ç›¸åŒï¼Œè·³è¿‡æ›´æ–°ï¼ˆæ”¯æŒé‡å¤å‘å¸ƒï¼‰"
          fi

          echo "å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·:"
          grep '"version"' package.json

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: æ„å»º WASM æ¨¡å—
        shell: bash
        run: |
          echo "æ„å»º macOS ARM64 WASM æ¨¡å—"
          cd packages/wasm
          # å°è¯•ä½¿ç”¨ sccacheï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªåŠ¨é™çº§åˆ°æ ‡å‡†æ„å»º
          export RUSTC_WRAPPER=sccache
          npx napi build --target aarch64-apple-darwin --platform --release || {
            echo "âš ï¸ sccache æ„å»ºå¤±è´¥ï¼Œé™çº§åˆ°æ ‡å‡†æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰"
            unset RUSTC_WRAPPER
            npx napi build --target aarch64-apple-darwin --platform --release
          }
          echo "WASM æ¨¡å—æ„å»ºå®Œæˆ"
        env:
          SCCACHE_GHA_ENABLED: 'true'
          RUST_BACKTRACE: '1'
          SCCACHE_NO_DAEMON: '1'

      - name: éªŒè¯ WASM æ¨¡å—
        shell: bash
        run: |
          echo "=== éªŒè¯ WASM æ¨¡å—æ„å»ºç»“æœ ==="
              expected_file="pixuli-wasm.darwin-arm64.node"
          echo "æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"

            if [ -f "packages/wasm/$expected_file" ]; then
              echo "âœ… æ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
              ls -la "packages/wasm/$expected_file"
            else
              echo "âŒ æœªæ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
              ls -la packages/wasm/*.node 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .node æ–‡ä»¶"
              exit 1
            fi
          echo "=== WASM æ¨¡å—éªŒè¯å®Œæˆ ==="

      - name: æ„å»ºå‰ç«¯èµ„æº
        shell: bash
        run: |
          echo "æ„å»ºå‰ç«¯èµ„æº (TypeScript & Vite)"
          cd apps/desktop
          pnpm run build:web

      - name: æ„å»ºæ¡Œé¢åº”ç”¨
        shell: bash
        run: |
          echo "æ„å»º macOS ARM64 æ¡Œé¢åº”ç”¨"
          cd apps/desktop
          npx electron-builder --mac --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pixuli-desktop-mac-arm64-v${{ steps.version.outputs.VERSION }}
          path: |
            apps/desktop/release/*.dmg
            !apps/desktop/release/*.blockmap
            !apps/desktop/release/*.yml
            !apps/desktop/release/*.map
          retention-days: 30

  build-linux:
    name: æ„å»º Linux
    needs: detect
    if: needs.detect.outputs.do_linux == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        id: pnpm-cache
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: è®¾ç½® Rust/Cargo ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: å®‰è£… sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: è®¾ç½® Cargo target ç›®å½•ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            packages/wasm/target/
          key: ${{ runner.os }}-wasm-target-${{ hashFiles('packages/wasm/Cargo.lock', 'packages/wasm/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-wasm-target-

      - name: æ˜¾ç¤ºå‘å¸ƒé…ç½®
        shell: bash
        run: |
          echo "=== å‘å¸ƒé…ç½®ä¿¡æ¯ ==="
          echo "ç‰ˆæœ¬å·: ${{ needs.detect.outputs.version }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ needs.detect.outputs.target_branch }}"
          echo "å¹³å°: Linux x64"
          echo "=================="

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: ä½¿ç”¨ pnpm version æ›´æ–°ç‰ˆæœ¬å·
        shell: bash
        run: |
          cd apps/desktop
          CURRENT_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"

          echo "å½“å‰ç‰ˆæœ¬å·: $CURRENT_VERSION"
          echo "ç›®æ ‡ç‰ˆæœ¬å·: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬å·ä¸º: $TARGET_VERSION"
            pnpm version $TARGET_VERSION --no-git-tag-version
          else
            echo "ç‰ˆæœ¬å·ç›¸åŒï¼Œè·³è¿‡æ›´æ–°ï¼ˆæ”¯æŒé‡å¤å‘å¸ƒï¼‰"
          fi

          echo "å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·:"
          grep '"version"' package.json

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: pnpm install --frozen-lockfile

      - name: æ„å»º WASM æ¨¡å—
        shell: bash
        run: |
          echo "æ„å»º Linux x64 WASM æ¨¡å—"
          cd packages/wasm
          # å°è¯•ä½¿ç”¨ sccacheï¼Œå¦‚æœå¤±è´¥åˆ™è‡ªåŠ¨é™çº§åˆ°æ ‡å‡†æ„å»º
          export RUSTC_WRAPPER=sccache
          npx napi build --target x86_64-unknown-linux-gnu --platform --release || {
            echo "âš ï¸ sccache æ„å»ºå¤±è´¥ï¼Œé™çº§åˆ°æ ‡å‡†æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰"
            unset RUSTC_WRAPPER
            npx napi build --target x86_64-unknown-linux-gnu --platform --release
          }
          echo "WASM æ¨¡å—æ„å»ºå®Œæˆ"
        env:
          SCCACHE_GHA_ENABLED: 'true'
          RUST_BACKTRACE: '1'
          SCCACHE_NO_DAEMON: '1'

      - name: éªŒè¯ WASM æ¨¡å—
        shell: bash
        run: |
          echo "=== éªŒè¯ WASM æ¨¡å—æ„å»ºç»“æœ ==="
          expected_file="pixuli-wasm.linux-x64-gnu.node"
          echo "æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"

          if [ -f "packages/wasm/$expected_file" ]; then
            echo "âœ… æ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la "packages/wasm/$expected_file"
          else
            echo "âŒ æœªæ‰¾åˆ°æœŸæœ›çš„äºŒè¿›åˆ¶æ–‡ä»¶: $expected_file"
            ls -la packages/wasm/*.node 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .node æ–‡ä»¶"
            exit 1
          fi
          echo "=== WASM æ¨¡å—éªŒè¯å®Œæˆ ==="

      - name: æ„å»ºå‰ç«¯èµ„æº
        shell: bash
        run: |
          echo "æ„å»ºå‰ç«¯èµ„æº (TypeScript & Vite)"
          cd apps/desktop
          pnpm run build:web

      - name: æ„å»ºæ¡Œé¢åº”ç”¨
        shell: bash
        run: |
          echo "æ„å»º Linux x64 æ¡Œé¢åº”ç”¨"
          cd apps/desktop
            npx electron-builder --linux --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: pixuli-desktop-linux-v${{ steps.version.outputs.VERSION }}
          path: |
            apps/desktop/release/*.AppImage
            !apps/desktop/release/*.blockmap
            !apps/desktop/release/*.yml
            !apps/desktop/release/*.map
          retention-days: 30

  skip-release:
    needs: [detect, build-win, build-mac-x64, build-mac-arm64, build-linux]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.detect.outputs.is_publish == 'false' &&
      (needs.build-win.result == 'success' || needs.build-win.result == 'skipped') &&
      (needs.build-mac-x64.result == 'success' || needs.build-mac-x64.result == 'skipped') &&
      (needs.build-mac-arm64.result == 'success' || needs.build-mac-arm64.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped')
    steps:
      - name: è·³è¿‡å‘å¸ƒ
        shell: bash
        run: |
          echo "=== å‘å¸ƒå·²è·³è¿‡ ==="
          echo "is-publish è®¾ç½®ä¸º falseï¼Œè·³è¿‡å‘å¸ƒç›¸å…³æ“ä½œ"
          echo "æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° artifactsï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
          echo "================"

  prepare-release:
    needs: [detect, build-win, build-mac-x64, build-mac-arm64, build-linux]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.detect.outputs.is_publish == 'true' &&
      (needs.build-win.result == 'success' || needs.build-win.result == 'skipped') &&
      (needs.build-mac-x64.result == 'success' || needs.build-mac-x64.result == 'skipped') &&
      (needs.build-mac-arm64.result == 'success' || needs.build-mac-arm64.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ›å»ºå‘å¸ƒ
        id: create_release
        shell: bash
        run: |
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if gh release view ${{ steps.version.outputs.TAG_VERSION }} >/dev/null 2>&1; then
            echo "æ ‡ç­¾ ${{ steps.version.outputs.TAG_VERSION }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            # ä½¿ç”¨ GitHub CLI åˆ›å»ºå‘å¸ƒ
            gh release create ${{ steps.version.outputs.TAG_VERSION }} \
              --title "Pixuli Desktop v${{ steps.version.outputs.VERSION }} - æ™ºèƒ½å›¾ç‰‡ç®¡ç†æ¡Œé¢åº”ç”¨" \
              --notes "## ğŸ‰ Pixuli Desktop v${{ steps.version.outputs.VERSION }} å‘å¸ƒ

              ### ğŸ“¦ ä¸‹è½½è¯´æ˜
              è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©ç›¸åº”çš„å®‰è£…åŒ…ï¼š

              **ğŸªŸ Windows ç”¨æˆ·**
              - ä¸‹è½½ `win` ç‰ˆæœ¬çš„ `.exe` æ–‡ä»¶è¿›è¡Œå®‰è£…
              - æ”¯æŒ Windows 10/11 (64ä½)
              - æ¨èä½¿ç”¨ Windows 10 1903 æˆ–æ›´é«˜ç‰ˆæœ¬

              **ğŸ macOS ç”¨æˆ·**
              - **Intel Mac**: ä¸‹è½½ `mac-x64` ç‰ˆæœ¬çš„ `.dmg` æ–‡ä»¶
              - **Apple Silicon Mac**: ä¸‹è½½ `mac-arm64` ç‰ˆæœ¬çš„ `.dmg` æ–‡ä»¶
              - æ”¯æŒ macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬

              **ğŸ§ Linux ç”¨æˆ·**
              - ä¸‹è½½ `linux` ç‰ˆæœ¬çš„ `.AppImage` æ–‡ä»¶
              - æ”¯æŒä¸»æµ Linux å‘è¡Œç‰ˆ (Ubuntu, Debian, Fedora, Arch ç­‰)
              - éœ€è¦ 64ä½ x86 æ¶æ„

              ### ğŸš€ å®‰è£…æŒ‡å—
              1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…
              2. è¿è¡Œå®‰è£…ç¨‹åºæˆ–è§£å‹æ–‡ä»¶
              3. æŒ‰ç…§å®‰è£…å‘å¯¼å®Œæˆå®‰è£…
              4. å¯åŠ¨ Pixuli Desktop å¼€å§‹ä½¿ç”¨

              ### ğŸ’» ç³»ç»Ÿè¦æ±‚
              - **Windows**: Windows 10/11 (64ä½), 4GB RAM, 2GB å¯ç”¨ç£ç›˜ç©ºé—´
              - **macOS**: macOS 10.15+, 4GB RAM, 2GB å¯ç”¨ç£ç›˜ç©ºé—´
              - **Linux**: ä¸»æµ Linux å‘è¡Œç‰ˆ, 4GB RAM, 2GB å¯ç”¨ç£ç›˜ç©ºé—´
              - **å¤„ç†å™¨**: Intel/AMD 64ä½å¤„ç†å™¨æˆ– Apple Silicon (M1/M2)

              ### ğŸ“‹ æ›´æ–°æ—¥å¿—
              - ç‰ˆæœ¬: v${{ steps.version.outputs.VERSION }}
              - æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              - æäº¤: ${{ github.sha }}
              - åˆ†æ”¯: ${{ needs.detect.outputs.target_branch }}

              ---
              *æ„Ÿè°¢æ‚¨ä½¿ç”¨ Pixuli Desktopï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šåé¦ˆã€‚*" \
              --draft=false \
              --prerelease=false
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        if: needs.detect.outputs.do_win == 'true'
        shell: bash
        run: |
          # æŸ¥æ‰¾ Windows æ„å»ºäº§ç‰©
          find artifacts/pixuli-desktop-win-v${{ steps.version.outputs.VERSION }} -name "*.exe" -type f | while read file; do
            echo "ä¸Šä¼ æ–‡ä»¶: $file"
            gh release upload ${{ steps.version.outputs.TAG_VERSION }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  macOS x64 DMG åŒ…
        if: needs.detect.outputs.do_mac_x64 == 'true'
        shell: bash
        run: |
          # æŸ¥æ‰¾ macOS x64 DMG æ„å»ºäº§ç‰©
          find artifacts/pixuli-desktop-mac-x64-v${{ steps.version.outputs.VERSION }} -name "*.dmg" -type f | while read file; do
            echo "ä¸Šä¼  macOS x64 æ–‡ä»¶: $file"
            gh release upload ${{ steps.version.outputs.TAG_VERSION }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  macOS ARM64 DMG åŒ…
        if: needs.detect.outputs.do_mac_arm64 == 'true'
        shell: bash
        run: |
          # æŸ¥æ‰¾ macOS ARM64 DMG æ„å»ºäº§ç‰©
          find artifacts/pixuli-desktop-mac-arm64-v${{ steps.version.outputs.VERSION }} -name "*.dmg" -type f | while read file; do
            echo "ä¸Šä¼  macOS ARM64 æ–‡ä»¶: $file"
            gh release upload ${{ steps.version.outputs.TAG_VERSION }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  Linux AppImage åŒ…
        if: needs.detect.outputs.do_linux == 'true'
        shell: bash
        run: |
          # æŸ¥æ‰¾ Linux AppImage æ„å»ºäº§ç‰©
          find artifacts/pixuli-desktop-linux-v${{ steps.version.outputs.VERSION }} -name "*.AppImage" -type f | while read file; do
            echo "ä¸Šä¼  Linux æ–‡ä»¶: $file"
            gh release upload ${{ steps.version.outputs.TAG_VERSION }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-version-and-publish:
    needs: [detect, prepare-release]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.detect.outputs.is_publish == 'true' &&
      needs.prepare-release.result == 'success'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ needs.detect.outputs.target_branch }}

      - name: æå–ç‰ˆæœ¬å·
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.detect.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: v$VERSION"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: æ‹‰å–è¿œç¨‹æ›´æ”¹
        shell: bash
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin ${{ needs.detect.outputs.target_branch }} --rebase

      - name: æ£€æŸ¥å¹¶æ›´æ–°ç‰ˆæœ¬å·
        shell: bash
        run: |
          # æ£€æŸ¥å¹¶æ›´æ–°ç‰ˆæœ¬å·ï¼ˆæ”¯æŒç›¸åŒç‰ˆæœ¬å·é‡å¤å‘å¸ƒï¼‰
          CURRENT_VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.version.outputs.VERSION }}"

          echo "å½“å‰ç‰ˆæœ¬å·: $CURRENT_VERSION"
          echo "ç›®æ ‡ç‰ˆæœ¬å·: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "ç‰ˆæœ¬å·ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬å·ä¸º: $TARGET_VERSION"
            pnpm version $TARGET_VERSION --no-git-tag-version
            VERSION_CHANGED=true
          else
            echo "ç‰ˆæœ¬å·ç›¸åŒï¼Œè·³è¿‡æ›´æ–°ï¼ˆæ”¯æŒé‡å¤å‘å¸ƒï¼‰"
            VERSION_CHANGED=false
          fi

          echo "å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬å·:"
          grep '"version"' package.json

          echo "VERSION_CHANGED=$VERSION_CHANGED" >> $GITHUB_ENV

      - name: æäº¤ç‰ˆæœ¬å·æ›´æ–°
        shell: bash
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if [ "$VERSION_CHANGED" = "true" ]; then
            echo "ç‰ˆæœ¬å·å·²æ›´æ–°ï¼Œæäº¤æ›´æ”¹"
            git add package.json
            git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }}"
            git push origin ${{ needs.detect.outputs.target_branch }}
            echo "ç‰ˆæœ¬å·æ›´æ–°å·²æäº¤å¹¶æ¨é€"
          else
            echo "ç‰ˆæœ¬å·æœªå˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi
