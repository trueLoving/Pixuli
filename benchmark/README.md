# Pixuli 性能基准测试

这个目录包含了 Pixuli
WASM 和 JavaScript 图片压缩功能的性能对比测试，用于验证 WASM 实现的性能优势。

## 🎯 测试目标

- **性能对比**: WASM WebP 压缩 vs JavaScript 压缩
- **压缩效果**: 不同质量设置的压缩率和效果
- **批量处理**: 多图片批量压缩性能
- **内存使用**: 内存占用情况对比
- **稳定性**: 连续运行稳定性测试

## 📁 测试文件

- `src/simple-compression-bench.ts` - 简化基准测试，快速验证基本性能
- `src/detailed-bench.ts` - 详细基准测试，包含多种测试场景和深度分析
- `test-images/` - 测试图片目录，包含 PNG 和 ICO 格式的测试图片

## 🚀 快速开始

### 安装依赖

```bash
cd benchmark
pnpm install
```

### 运行测试

#### 简化基准测试（推荐）

```bash
pnpm run benchmark:simple
```

#### 详细基准测试

```bash
pnpm run benchmark:detailed
```

#### 运行所有测试

```bash
pnpm run benchmark
```

## 📊 测试内容

### 1. 单次压缩性能对比

- **WASM WebP 压缩** vs **JavaScript 压缩**
- 处理时间对比（毫秒）
- 操作频率对比（ops/sec）
- 性能提升百分比

### 2. 不同质量设置测试

- 质量范围：60, 70, 80, 90, 95
- 压缩率对比
- 处理时间对比
- 质量 vs 性能权衡分析

### 3. 批量压缩性能测试

- 批量大小：2, 5, 10 张图片
- WASM 批量处理 vs JavaScript 并行处理
- 批量处理效率对比
- 内存使用情况

### 4. 压缩效果对比

- 原始文件大小
- 压缩后文件大小
- 压缩率百分比
- 图片尺寸信息

### 5. 内存使用对比

- WASM 压缩内存占用
- JavaScript 压缩内存占用
- 内存效率对比

### 6. 稳定性测试

- 连续运行 100 次测试
- 错误率统计
- 平均处理时间
- 性能稳定性分析

## 🛠️ 技术实现

### 测试框架

- **TinyBench**: 高性能基准测试框架
- **TypeScript**: 类型安全的测试代码
- **Node.js**: 服务端测试环境

### 测试数据

- **真实图片**: 使用项目中的测试图片文件
- **模拟数据**: 当无测试图片时使用随机数据
- **多种格式**: 支持 PNG、ICO 等格式

### WASM 模块

- **pixuli-wasm**: 项目自研的 WASM 图片处理模块
- **WebP 压缩**: 支持有损和无损压缩
- **批量处理**: 支持多图片批量压缩

## 📈 预期结果

根据测试，WASM WebP 压缩相比 JavaScript 压缩通常具有以下优势：

### ⚡ 性能优势

- **更快的处理速度** - 通常快 2-10 倍
- **更高的操作频率** - 更高的 ops/sec
- **更低的延迟** - 更快的响应时间

### 📦 压缩优势

- **更好的压缩效果** - WebP 格式压缩率更高
- **更精确的质量控制** - 支持 0-100 质量设置
- **无损压缩支持** - 支持无损压缩模式

### 💾 资源优势

- **更低的内存使用** - 原生代码更高效
- **更好的稳定性** - 更少的错误率
- **批量处理优化** - 批量压缩效率更高

## 📋 测试指标

### 性能指标

- **处理时间** (毫秒)
- **操作频率** (ops/sec)
- **性能提升** (百分比)
- **平均时间** (毫秒)

### 压缩指标

- **压缩率** (百分比)
- **文件大小** (字节)
- **质量设置** (0-100)
- **图片尺寸** (宽x高)

### 资源指标

- **内存使用** (MB)
- **错误率** (百分比)
- **稳定性** (连续运行成功率)

## ⚠️ 注意事项

1. **测试环境**: 测试结果可能因硬件配置而异
2. **WASM 编译**: 首次运行可能需要编译 WASM 模块
3. **测试数据**: 使用真实图片时会在 test-images 目录中查找
4. **内存监控**: 测试会监控内存使用情况
5. **多次运行**: 建议多次运行以获得准确的性能数据
6. **环境一致性**: 建议在相同环境下进行对比测试

## 🔧 自定义测试

### 修改测试参数

```typescript
// 修改测试时间
const bench = new Bench({
  time: 5000, // 运行 5 秒
  iterations: 20, // 最少 20 次迭代
});

// 修改质量设置
const qualities = [60, 70, 80, 90, 95];

// 修改批量大小
const batchSizes = [2, 5, 10];
```

### 添加新的测试场景

```typescript
// 添加新的压缩选项测试
bench.add('WASM WebP 自定义质量', async () => {
  const result = compressToWebp(imageData, { quality: 85 });
  return result;
});
```

## 📊 结果分析

测试完成后会输出详细的性能报告：

- **性能对比表格** - 直观的性能数据对比
- **压缩效果分析** - 压缩率和文件大小对比
- **内存使用报告** - 内存占用情况
- **稳定性统计** - 错误率和稳定性分析
- **综合总结** - 整体性能优势总结

## 🎉 测试完成

测试完成后会显示：

- ✅ WASM WebP 压缩的各项优势
- 📈 详细的性能指标
- 🎯 压缩效果对比
- 💾 内存使用情况
- 🔄 稳定性测试结果
